<!DOCTYPE html>
<html lang="en">
<head>
  <script src="js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Cloud - Project Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>

<body>

<div class="container">
  <div class="card mx-auto">

  <div class="card-header">
    <div class="d-flex flex-column">
      <!-- Heading on top -->
      <div class="mb-0 text-left">
        <h2>üöÄGPU Cloud Dashboard</h2>
      </div>
      <!-- Buttons below -->
      <div class="d-flex justify-content-end gap-1">
        <!-- Documentation Links -->
        <div class="btn-group btn-group-sm" role="group">
          <a href="project_overview.html" class="btn btn-outline-light btn-sm" target="_blank" title="Complete User Guide">
            üó∫Ô∏è Overview
          </a>
          <a href="documentation.html" class="btn btn-outline-light btn-sm" target="_blank" title="Complete User Guide">
            üìñ Documentation
          </a>
          <a href="cheatsheet.html" class="btn btn-outline-light btn-sm" target="_blank" title="Quick Reference">
            ‚ö°Cheat Sheet
          </a>
        </div>
          <!-- <button class="btn btn-light btn-sm" onclick="goBackToProjectPanel()">‚Üê Back</button> -->
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Status Message -->
      <div id="status-message"></div>

      <div id="projectsList" style="max-height: 220px; overflow-y: auto; padding: 0;">
        <div class="text-center text-muted p-3">
          <p class="text-center mt-0 mb-0 fs-5">Loading Projects...</p>
          <div class="empty-state-icon" style="font-size: 2.5rem;">‚è≥</div>
        </div>
      </div>

      <!-- Project Info Display -->
      <div id="project-info" class="project-info">
        <div id="project-info-content"></div>
      </div>
      
      <!-- Action Buttons (Create VM / Handle VMs) -->
      <div class="button-group">
        <button class="btn btn-success" 
                id="createVmBtn" 
                onclick="openCreateVmPage()" 
                disabled
                title="Validate project first">
          ‚ûïüñ•Ô∏è Create VM
        </button>
        <button class="btn btn-warning" 
                id="handleVmsBtn" 
                onclick="openHandleVmsPage()" 
                disabled
                title="Validate project first">
          ‚öôÔ∏èüñ•Ô∏è Manage VMs
        </button>
      </div>

      <div class="button-group">
        <button class="btn btn-dark" 
                id="createVolumeBtn" 
                onclick="openCreateVolumePage()" 
                disabled
                title="Validate project first">
          ‚ûïüíæ Create Volume
        </button>
        <button class="btn btn-secondary" 
                id="handleVolumesBtn" 
                onclick="openHandleVolumesPage()" 
                disabled
                title="Validate project first">
          ‚öôÔ∏èüíæ Manage Volumes
        </button>
      </div>

      <div class="btn-disabled-info" id="disabledInfo">
        ‚ÑπÔ∏è Validate your project ID first
      </div>
    
      <div id="admin-access" style="display:none; margin-top: 10px; margin-bottom: 0; text-align:center;">
        <button class="btn btn-outline-dark btn-sm" id="admin-btn">
          Admin Panel
        </button>
      </div>

    </div>

    <div class="card-footer text-center bg-white">
      <img src="https://commons.wikimedia.org/wiki/Special:FilePath/HBKU_logo.svg"
          alt="HBKU Logo"
          style="height: 60px; width: auto;">
    </div>
  </div>

<!-- <footer class="text-center py-3 mt-4 border-top">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</footer>
</div> -->

<!-- Footer -->
<div class="footer">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page" target="_blank">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentUser = null;
let userProjects = [];

// Check authentication on page load
document.addEventListener('DOMContentLoaded', async () => {
  currentUser = await requireAuth();
  
  if (!currentUser) return; // Will redirect to login
  
  // Load user's projects
  userProjects = await getUserProjects(currentUser.id);
  
  // Display user info
  displayUserInfo();
  fetchAssignedProjects();
});

async function fetchAssignedProjects() {

  const payload = { user_email: currentUser.email };
  try {
    // Show loading
    document.getElementById("projectsList").style.display = "block";
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/list_projects`;

    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
        throw new Error("Failed to fetch assigned projects");
    }

    const data = await response.json();
    console.log('Response received:', data);
    renderProjectsList(data.projects, data.message);
    return;

    // if (data.success) {
    //   // Hide loading
    //   // document.getElementById("projectsList").style.display = "none";
    //   console.log('Success response received:');
    //   renderProjectsList(data.projects, data.message);
    //   return;
    // } else {
    //   console.log('Fail response received:');
    //   renderProjectsList(data.projects, data.message);
    //   return;
    // }
  } catch (error) {
      console.error(error);
      document.getElementById("projectsList").innerHTML =
          "<p class='text-danger'>Unable to load your projects.</p>";
      return;
  }
}

function renderProjectsList(projectlist, message) {
  console.log('renderProjectsList called with projects:', projectlist);  
  const projects = projectlist || [];
  const projectsListDiv = document.getElementById('projectsList');

  if (projects.length === 0) {
    console.log('projects.length === 0:', message); 
    projectsListDiv.innerHTML = '<div class="text-muted p-3">No Projects Assigned</div>';
    // Disable buttons if no Projects exist
    disableActionButtons();
    return;
  }

  projectsListDiv.innerHTML = `
    <div class="list-group list-group-flush">
      ${projects.map(project => `
        <div class="list-group-item list-group-item-action" 
              onclick="selectProject('${escapeHtml(project.project_name)}', '${escapeHtml(project.project_id)}')"
              data-project-name="${escapeHtml(project.project_name)}"
              style="cursor: pointer;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${escapeHtml(project.project_name)}</strong>
              <br>
              <small class="text-muted">
                ${escapeHtml(project.project_id) || 'N/A'} ‚Ä¢ Remaining Credits: $${escapeHtml(project.remaining_credits || 0).toFixed(2)}
              </small>
            </div>
            <span class="project-role ${project.role}">${escapeHtml(project.role)}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  // Ensure buttons are disabled until a selection is made (unless a selection was preserved)
  disableActionButtons();
}

function selectProject(projectName, projectId) {

    // Highlight the selected item in the list
    const listItems = document.querySelectorAll('#projectsList .list-group-item');
    listItems.forEach(item => {
        item.classList.remove('selected');
    });

    // Find and highlight the specific item
    const selectedItem = document.querySelector(`[data-project-name="${projectName}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }

    // 4. Enable the action buttons
    // enableActionButtons();
    const projectInfo = document.getElementById('project-info');
    projectInfo.className = '';

    const projectInfoContent = document.getElementById('project-info-content');
    projectInfoContent.innerHTML = "";
    checkProjectStatus(projectId);
}

async function checkAdminAccess() {
  const user = await getCurrentUser();
  if (!user) return;

  // Check user_profiles.is_system_admin
  const { data, error } = await supabase
    .from('user_profiles')
    .select('is_system_admin')
    .eq('id', user.id)
    .single();

  if (error) {
    console.error('Error checking admin access:', error);
    return;
  }

  if (data && data.is_system_admin) {
    const adminContainer = document.getElementById('admin-access');
    const adminBtn = document.getElementById('admin-btn');
    adminContainer.style.display = 'block';

    // Open admin.html in a new tab
    adminBtn.onclick = () => {
      window.open('admin.html', '_blank');
    };
  }
}

document.addEventListener('DOMContentLoaded', checkAdminAccess);

function displayUserInfo() {
  // Add user menu to page
  const userMenu = `
    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      <div class="dropdown">
        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
          üë§ ${currentUser.email}
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="showProfile()">Profile</a></li>
          <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
        </ul>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('afterbegin', userMenu);
}

function showProfile() {
  alert('Profile page coming soon!');
}



// State management
let projectState = {
  projectId: null,
  isValid: false,
  projectData: null
};

// Show loading spinner on button
// function setButtonLoading(isLoading) {
//   const btn = document.querySelector('button[onclick="checkProjectStatus()"]');
//   const spinner = document.getElementById('checkBtn-spinner');
//   const text = document.getElementById('checkBtn-text');
  
//   if (isLoading) {
//     btn.disabled = true;
//     spinner.style.display = 'inline-block';
//     text.style.opacity = '0.7';
//   } else {
//     btn.disabled = false;
//     spinner.style.display = 'none';
//     text.style.opacity = '1';
//   }
// }

// Check project status
async function checkProjectStatus(projectId) {
  // const projectIdInput = document.getElementById('projectId').value.trim();
  
  // if (!projectId) {
  //   showMessage('Please enter a Project ID', 'warning');
  //   return;
  // }

  // Check if user has access to this project
  const hasAccess = userProjects.some(p => p.project_id === projectId);
  
  if (!hasAccess) {
    showMessage('‚ö†Ô∏è You do not have access to this project. Please contact the project owner.', 'warning');
    return;
  }

  // Set loading state
  // setButtonLoading(true);
  projectState.projectId = projectId;

  try {
    // Call n8n webhook to validate project
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/project_id_check?project_id=${encodeURIComponent(projectId)}`;
    
    console.log('üîç Checking project status for:', projectId);

    const response = await fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_id: projectId })
    });

    const responseText = await response.text();
    console.log('üì° Response:', responseText);

    let data;
    try {
      data = JSON.parse(responseText);
    } catch (e) {
      console.error('Failed to parse JSON:', responseText);
      throw new Error('Invalid response from server');
    }

    // Handle response
    if (data.success) {
      projectState.isValid = true;
      projectState.projectData = data;

      // Store both ID and name
      localStorage.setItem('currentProjectId', data.project_id);
      localStorage.setItem('currentProjectName', data.project_name || 'My Project');
      
      // Enable action buttons
      enableActionButtons();
      
      // Display project info
      displayProjectInfo(data, true);
      
      // showMessage(`‚úÖ Project validated successfully!`, 'success');
      console.log('‚úÖ Project is valid:', data);
      
    } else {
      projectState.isValid = false;
      projectState.projectData = null;
      
      // Disable action buttons
      disableActionButtons();
      
      // Display error info
      displayProjectInfo(data, false);
      
      showMessage(`‚ùå Project validation failed: ${data.message || 'Unknown error'}`, 'danger');
      console.log('‚ùå Project is not valid:', data);
    }

  } catch (error) {
    console.error('Error:', error);
    projectState.isValid = false;
    disableActionButtons();
    showMessage(`Error: ${error.message}`, 'danger');
  } finally {
    // setButtonLoading(false);
  }
}

async function displayProjectInfo(data, isSuccess) {
  const projectInfo = document.getElementById('project-info');
  const projectInfoContent = document.getElementById('project-info-content');

  // Calculate remaining credits
  const remainingCredits = (data.credits || 0) - (data.used_credits || 0);
  
  if (isSuccess && remainingCredits > 0) {
    // Store credit status
    localStorage.setItem('hasCredits', 'true');

    // Check if user is PI (owner) of this project
    const { data: membership } = await supabaseClient
      .from('project_members')
      .select('role')
      .eq('project_id', data.project_id)
      .eq('user_id', currentUser.id)
      .single();
    
    const isOwner = membership?.role === 'owner';
    
    // Check if system admin
    const { data: profile } = await supabaseClient
      .from('user_profiles')
      .select('is_system_admin')
      .eq('id', currentUser.id)
      .single();
    
    const isSystemAdmin = profile?.is_system_admin || false;
    projectInfo.className = 'project-info visible success';
    projectInfoContent.innerHTML = `
      <strong>‚úì Project Validated</strong><br>
      <small>Project: ${escapeHtml(data.project_name || 'My Project')}</small><br>
      <small>Project Responsible: ${escapeHtml(data.pi_name)}</small><br>
      <small>ID: ${escapeHtml(data.project_id)}</small><br>
      <small>Status: ${escapeHtml(data.status) || 'Active'}</small><br>
      <small>Remaining Credits: $${escapeHtml(remainingCredits.toFixed(2))}</small>
      <br>
      ${(isOwner || isSystemAdmin) ? `
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.open('team_management.html', '_blank')">
          üë• Manage Team
        </button>
      ` : ''}
      ${isSystemAdmin ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="window.open('admin.html', '_blank')">
          üîê System Admin
        </button>
      ` : ''}
    `;    
    } else if (isSuccess && remainingCredits <= 0) {
      projectInfo.className = 'project-info visible error';
      projectInfoContent.innerHTML = `
      <strong>üí∞‚ùå Project Out of Credits</strong><br>
      <small>Project: ${escapeHtml(data.project_name || 'My Project')}</small><br>
      <small>ID: ${escapeHtml(data.project_id)}</small><br>
      <small style="color: #dc3545; font-weight: bold;">
        Credits exhausted: ${escapeHtml(data.used_credits.toFixed(2))} / ${escapeHtml(data.credits.toFixed(2))}
      </small><br>
      <small>Please contact RCCG to add more credits.</small>
      `;
      
      // Store credit status
      localStorage.setItem('hasCredits', 'false');
      
      // Keep buttons disabled
      disableActionButtons();
      document.getElementById('disabledInfo').innerHTML = 
        'üí∞‚ùå Project is out of credits';
    } else {
      projectInfo.className = 'project-info visible error';
      projectInfoContent.innerHTML = `
        <strong>‚úó Validation Failed</strong><br>
        <small>${escapeHtml(data.message || 'Unknown error')}</small>
      `;
      localStorage.setItem('hasCredits', 'false');
      projectInfo.classList.add('error');
      projectInfo.classList.remove('success');
    }
}

// Enable action buttons
function enableActionButtons() {
  const createVmBtn = document.getElementById('createVmBtn');
  const handleVmsBtn = document.getElementById('handleVmsBtn');
  const createVolumeBtn = document.getElementById('createVolumeBtn');
  const handleVolumesBtn = document.getElementById('handleVolumesBtn');
  const disabledInfo = document.getElementById('disabledInfo');
  
  createVmBtn.disabled = false;
  handleVmsBtn.disabled = false;
  createVolumeBtn.disabled = false;
  handleVolumesBtn.disabled = false;

  createVmBtn.title = 'Click to create a new VM';
  handleVmsBtn.title = 'Click to manage existing VMs';
  disabledInfo.style.display = 'none';
  
  console.log('‚úÖ Buttons enabled');
}

// Disable action buttons
function disableActionButtons() {
  const createVmBtn = document.getElementById('createVmBtn');
  const handleVmsBtn = document.getElementById('handleVmsBtn');
  const disabledInfo = document.getElementById('disabledInfo');
  
  createVmBtn.disabled = true;
  handleVmsBtn.disabled = true;
  createVmBtn.title = 'Validate project first';
  handleVmsBtn.title = 'Validate project first';
  disabledInfo.style.display = 'block';
  
  console.log('‚ùå Buttons disabled');
}

// Open Create VM page
function openCreateVmPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Create VM page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const createVmUrl = `create_vm.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  //window.location.href = createVmUrl;
  
  // Alternative: Open in new tab
  window.open(createVmUrl, '_blank');
}

// Open Handle VMs page
function openHandleVmsPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Handle VMs page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const handleVmsUrl = `handle_vms.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  // window.location.href = handleVmsUrl;
  
  // Alternative: Open in new tab
  window.open(handleVmsUrl, '_blank');
}

// Open Create Volume page
function openCreateVolumePage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Create Volume page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const createVolumeUrl = `create_volume.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  //window.location.href = createVmUrl;
  
  // Open in new tab
  window.open(createVolumeUrl, '_blank');
}

// Open Handle Volume page
function openHandleVolumesPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Handle Volumes page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const handleVolumesUrl = `handle_volumes.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  // window.location.href = handleVmsUrl;
  
  // Open in new tab
  window.open(handleVolumesUrl, '_blank');
}

// Handle Enter key on input field
// function handleEnter(event) {
//   if (event.key === 'Enter') {
//     checkProjectStatus();
//   }
// }

// Extract project ID from URL if provided
function initializeFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const projectIdFromUrl = urlParams.get('project_id');
  
  if (projectIdFromUrl) {
    document.getElementById('projectId').value = projectIdFromUrl;
    console.log('üìç Project ID from URL:', projectIdFromUrl);
  }
}

// Initialize on page load
window.addEventListener('load', () => {
  console.log('‚úÖ Project Panel loaded');
  initializeFromUrl();
});
</script>

<script src="utils.js"></script>
</body>
</html>