<!DOCTYPE html>
<html lang="en">
<head>
  <script src="js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Cloud - Project Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <script src="utils.js"></script>
</head>

<body>

<div class="container">
  <div class="card mx-auto">

  <div class="card-header">
    <div class="d-flex flex-column">
      <!-- Heading on top -->
      <div class="mb-0 text-left">
        <h2>üöÄGPU Cloud Dashboard</h2>
      </div>
      <!-- <div class="d-flex justify-content-end gap-1">
        <div class="btn-group btn-group-sm" role="group">
          <a href="cheatsheet.html" class="btn btn-outline-light btn-sm" target="_blank" title="Quick Reference">
            ‚ö°Cheat Sheet
          </a>
        </div>
      </div> -->

      <div class="d-flex gap-2 align-items-center">
        <!-- Learning Hub Dropdown -->
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle d-flex align-items-center gap-2" 
                  type="button" 
                  id="learningHubDropdown" 
                  data-bs-toggle="dropdown" 
                  aria-expanded="false">
            <i data-lucide="graduation-cap"></i> Learning Hub
          </button>
          <ul class="dropdown-menu dropdown-menu-end learning-hub-menu" aria-labelledby="learningHubDropdown">
            <!-- Getting Started Section -->
            <li><h6 class="dropdown-header"><i data-lucide="rocket"></i> Getting Started</h6></li>
            <li>
              <a class="dropdown-item" href="beginner_guide.html" target="_blank">
                <span class="menu-icon">üèÅ</span>
                <div class="menu-content">
                  <div class="menu-title">Beginner Guide</div>
                  <div class="menu-subtitle">Step-by-step walkthrough</div>
                </div>
              </a>
            </li>
            
            <!-- Advanced Section -->
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header"><i data-lucide="zap"></i>Advanced Workflows</h6></li>
            <li>
              <a class="dropdown-item" href="intermediate_guide.html" target="_blank">
                <span class="menu-icon">‚ö°</span>
                <div class="menu-content">
                  <div class="menu-title">Intermediate Guide</div>
                  <div class="menu-subtitle">Volumes, staging, containers</div>
                </div>
              </a>
            </li>
            
            <!-- Reference Materials -->
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header"><i data-lucide="book-text"></i> Reference Materials</h6></li>
            <li>
              <a class="dropdown-item" href="project_overview.html" target="_blank">
                <span class="menu-icon">üó∫Ô∏è</span>
                <div class="menu-content">
                  <div class="menu-title">Project Overview</div>
                  <div class="menu-subtitle">Architecture & vision</div>
                </div>
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="documentation.html" target="_blank">
                <span class="menu-icon">üìñ</span>
                <div class="menu-content">
                  <div class="menu-title">Documentation</div>
                  <div class="menu-subtitle">Complete user guide</div>
                </div>
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="cheatsheet.html" target="_blank">
                <span class="menu-icon">‚ö°</span>
                <div class="menu-content">
                  <div class="menu-title">Cheat Sheet</div>
                  <div class="menu-subtitle">Quick command reference</div>
                </div>
              </a>
            </li>
          </ul>
        </div>
      </div>

      
    </div>
  </div>

    <div class="card-body">
      <!-- Status Message -->
      <div id="status-message"></div>

      <div id="projectsList" style="max-height: 220px; overflow-y: auto; padding: 0;">
        <div class="text-center text-muted p-3">
          <p class="text-center mt-0 mb-0 fs-5">Loading Projects...</p>
          <div class="empty-state-icon" style="font-size: 2.5rem;">‚è≥</div>
        </div>
      </div>

      <!-- Project Info Display -->
      <div id="project-info" class="project-info">
        <div id="project-info-content"></div>
      </div>
      
      <!-- Action Buttons (Create VM / Handle VMs) -->
      <div class="button-group">
        <button class="btn btn-success" 
                id="createVmBtn" 
                onclick="openCreateVmPage()" 
                disabled
                title="Validate project first">
          ‚ûïüñ•Ô∏è Create VM
        </button>
        <button class="btn btn-warning" 
                id="handleVmsBtn" 
                onclick="openHandleVmsPage()" 
                disabled
                title="Validate project first">
          ‚öôÔ∏èüñ•Ô∏è Manage VMs
        </button>
      </div>

      <div class="button-group">
        <button class="btn btn-dark" 
                id="createVolumeBtn" 
                onclick="openCreateVolumePage()" 
                disabled
                title="Validate project first">
          ‚ûïüíæ Create Volume
        </button>
        <button class="btn btn-secondary" 
                id="handleVolumesBtn" 
                onclick="openHandleVolumesPage()" 
                disabled
                title="Validate project first">
          ‚öôÔ∏èüíæ Manage Volumes
        </button>
      </div>

      <div class="btn-disabled-info" id="disabledInfo">
        ‚ÑπÔ∏è Validate your project ID first
      </div>
    
      <div id="admin-access" style="display:none; margin-top: 10px; margin-bottom: 0; text-align:center;">
        <button class="btn btn-outline-dark btn-sm" id="admin-btn">
          Admin Panel
        </button>
      </div>

    </div>

    <div class="card-footer text-center bg-white">
      <img src="https://commons.wikimedia.org/wiki/Special:FilePath/HBKU_logo.svg"
          alt="HBKU Logo"
          style="height: 60px; width: auto;">
    </div>
  </div>

<!-- <footer class="text-center py-3 mt-4 border-top">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</footer>
</div> -->

<!-- Footer -->
<div class="footer">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page" target="_blank">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
lucide.createIcons();
let currentUser = null;
let userProjects = [];

// Check authentication on page load
document.addEventListener('DOMContentLoaded', async () => {
  currentUser = await requireAuth();
  
  if (!currentUser) return; // Will redirect to login
  
  // Load user's projects
  userProjects = await getUserProjects(currentUser.id);
  
  // Display user info
  displayUserInfo();
  fetchAssignedProjects();
});

async function fetchAssignedProjects() {

  const payload = { user_email: currentUser.email };
  try {
    // Show loading
    document.getElementById("projectsList").style.display = "block";
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/list_projects`;

    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
        throw new Error("Failed to fetch assigned projects");
    }

    const data = await response.json();
    console.log('Response received:', data);
    renderProjectsList(data.projects, data.message);
    return;

  } catch (error) {
      console.error(error);
      document.getElementById("projectsList").innerHTML =
          "<p class='text-danger'>Unable to load your projects.</p>";
      return;
  }
}

function renderProjectsList(projectlist, message) {
  console.log('renderProjectsList called with projects:', projectlist);  
  const projects = projectlist || [];
  const projectsListDiv = document.getElementById('projectsList');

  if (projects.length === 0) {
    console.log('projects.length === 0:', message); 
    projectsListDiv.innerHTML = '<div class="text-muted p-3">No Projects Assigned</div>';
    // Disable buttons if no Projects exist
    disableActionButtons();
    return;
  }

  projectsListDiv.innerHTML = `
    <div class="list-group list-group-flush">
      ${projects.map(project => `
        <div class="list-group-item list-group-item-action" 
              onclick="selectProject('${escapeHtml(project.project_name)}', '${escapeHtml(project.project_id)}')"
              data-project-name="${escapeHtml(project.project_name)}"
              style="cursor: pointer;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong class="badge bg-light text-dark border fs-6">${escapeHtml(project.project_name)}</strong>
              <br>
              <small class="text-muted">
                ${escapeHtml(project.project_id) || 'N/A'} ‚Ä¢ Remaining Credits: $${(project.remaining_credits || 0).toFixed(2)}
              </small>
            </div>
            <span class="project-role ${project.role}">${escapeHtml(project.role)}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  // Ensure buttons are disabled until a selection is made (unless a selection was preserved)
  disableActionButtons();
}

function selectProject(projectName, projectId) {

    // Highlight the selected item in the list
    const listItems = document.querySelectorAll('#projectsList .list-group-item');
    listItems.forEach(item => {
        item.classList.remove('selected');
    });

    // Find and highlight the specific item
    const selectedItem = document.querySelector(`[data-project-name="${projectName}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }

    // 4. Enable the action buttons
    // enableActionButtons();
    const projectInfo = document.getElementById('project-info');
    projectInfo.className = '';

    const projectInfoContent = document.getElementById('project-info-content');
    projectInfoContent.innerHTML = "";
    checkProjectStatus(projectId);
}

async function checkAdminAccess() {
  const user = await getCurrentUser();
  if (!user) return;

  // Check user_profiles.is_system_admin
  const { data, error } = await supabaseClient
    .from('user_profiles')
    .select('is_system_admin')
    .eq('id', user.id)
    .single();

  if (error) {
    console.error('Error checking admin access:', error);
    return;
  }

  if (data && data.is_system_admin) {
    const adminContainer = document.getElementById('admin-access');
    const adminBtn = document.getElementById('admin-btn');
    adminContainer.style.display = 'block';

    // Open admin.html in a new tab
    adminBtn.onclick = () => {
      window.open('admin.html', '_blank');
    };
  }
}

document.addEventListener('DOMContentLoaded', checkAdminAccess);

function displayUserInfo() {
  // Add user menu to page
  const userMenu = `
    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      <div class="dropdown">
        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
          üë§ ${currentUser.email}
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="showProfile()">Profile</a></li>
          <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
        </ul>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('afterbegin', userMenu);
}

function showProfile() {
  alert('Profile page coming soon!');
}



// State management
let projectState = {
  projectId: null,
  isValid: false,
  projectData: null
};


// Check project status
async function checkProjectStatus(projectId) {
  // Check if user has access to this project
  const hasAccess = userProjects.some(p => p.project_id === projectId);
  
  if (!hasAccess) {
    showMessage('‚ö†Ô∏è You do not have access to this project. Please contact the project owner.', 'warning');
    return;
  }

  // Set loading state
  // setButtonLoading(true);
  projectState.projectId = projectId;

  try {
    // Call n8n webhook to validate project
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/project_id_check?project_id=${encodeURIComponent(projectId)}`;
    
    console.log('üîç Checking project status for:', projectId);

    const response = await fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_id: projectId })
    });

    const responseText = await response.text();
    console.log('üì° Response:', responseText);

    let data;
    try {
      data = JSON.parse(responseText);
    } catch (e) {
      console.error('Failed to parse JSON:', responseText);
      throw new Error('Invalid response from server');
    }

    // Handle response
    if (data.success) {
      projectState.isValid = true;
      projectState.projectData = data;

      // Store both ID and name
      localStorage.setItem('currentProjectId', data.project_id);
      localStorage.setItem('currentProjectName', data.project_name || 'My Project');
      
      // Enable action buttons
      enableActionButtons();
      
      // Display project info
      displayProjectInfo(data, true);
      
      // showMessage(`‚úÖ Project validated successfully!`, 'success');
      console.log('‚úÖ Project is valid:', data);
      
    } else {
      projectState.isValid = false;
      projectState.projectData = null;
      
      // Disable action buttons
      disableActionButtons();
      
      // Display error info
      displayProjectInfo(data, false);
      
      showMessage(`‚ùå Project validation failed: ${data.message || 'Unknown error'}`, 'danger');
      console.log('‚ùå Project is not valid:', data);
    }

  } catch (error) {
    console.error('Error:', error);
    projectState.isValid = false;
    disableActionButtons();
    showMessage(`Error: ${error.message}`, 'danger');
  } finally {
    // setButtonLoading(false);
  }
}

async function displayProjectInfo(data, isSuccess) {
  const projectInfo = document.getElementById('project-info');
  const projectInfoContent = document.getElementById('project-info-content');

  // Calculate remaining credits
  const remainingCredits = (data.credits || 0) - (data.used_credits || 0);
  
  if (isSuccess && remainingCredits > 0) {
    // Store credit status
    localStorage.setItem('hasCredits', 'true');

    // Check if user is PI (owner) of this project
    const { data: membership } = await supabaseClient
      .from('project_members')
      .select('role')
      .eq('project_id', data.project_id)
      .eq('user_id', currentUser.id)
      .single();
    
    const isOwner = membership?.role === 'owner';
    
    // Check if system admin
    const { data: profile } = await supabaseClient
      .from('user_profiles')
      .select('is_system_admin')
      .eq('id', currentUser.id)
      .single();
    
    const isSystemAdmin = profile?.is_system_admin || false;
    projectInfo.className = 'project-info visible success';
    projectInfoContent.innerHTML = `
      <strong>‚úì Project Validated</strong><br>
      <small>Project: ${escapeHtml(data.project_name || 'My Project')}</small><br>
      <small>Project Responsible: ${escapeHtml(data.pi_name)}</small><br>
      <small>ID: ${escapeHtml(data.project_id)}</small><br>
      <small>Status: ${escapeHtml(data.status) || 'Active'}</small><br>
      <small>Remaining Credits: $${escapeHtml(remainingCredits.toFixed(2))}</small>
      <br>
      ${(isOwner || isSystemAdmin) ? `
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.open('team_management.html', '_blank')">
          üë• Manage Team
        </button>
      ` : ''}
      ${isSystemAdmin ? `
        <button class="btn btn-sm btn-outline-danger mt-2" onclick="window.open('admin.html', '_blank')">
          üîê System Admin
        </button>
      ` : ''}
    `;    
    } else if (isSuccess && remainingCredits <= 0) {
      projectInfo.className = 'project-info visible error';
      projectInfoContent.innerHTML = `
      <strong>üí∞‚ùå Project Out of Credits</strong><br>
      <small>Project: ${escapeHtml(data.project_name || 'My Project')}</small><br>
      <small>ID: ${escapeHtml(data.project_id)}</small><br>
      <small style="color: #dc3545; font-weight: bold;">
        Credits exhausted: ${escapeHtml(data.used_credits.toFixed(2))} / ${escapeHtml(data.credits.toFixed(2))}
      </small><br>
      <small>Please contact RCCG to add more credits.</small>
      `;
      
      // Store credit status
      localStorage.setItem('hasCredits', 'false');
      
      // Keep buttons disabled
      disableActionButtons();
      document.getElementById('disabledInfo').innerHTML = 
        'üí∞‚ùå Project is out of credits';
    } else {
      projectInfo.className = 'project-info visible error';
      projectInfoContent.innerHTML = `
        <strong>‚úó Validation Failed</strong><br>
        <small>${escapeHtml(data.message || 'Unknown error')}</small>
      `;
      localStorage.setItem('hasCredits', 'false');
      projectInfo.classList.add('error');
      projectInfo.classList.remove('success');
    }
}

// Enable action buttons
function enableActionButtons() {
  const createVmBtn = document.getElementById('createVmBtn');
  const handleVmsBtn = document.getElementById('handleVmsBtn');
  const createVolumeBtn = document.getElementById('createVolumeBtn');
  const handleVolumesBtn = document.getElementById('handleVolumesBtn');
  const disabledInfo = document.getElementById('disabledInfo');
  
  createVmBtn.disabled = false;
  handleVmsBtn.disabled = false;
  createVolumeBtn.disabled = false;
  handleVolumesBtn.disabled = false;

  createVmBtn.title = 'Click to create a new VM';
  handleVmsBtn.title = 'Click to manage existing VMs';
  disabledInfo.style.display = 'none';
  
  console.log('‚úÖ Buttons enabled');
}

// Disable action buttons
function disableActionButtons() {
  const createVmBtn = document.getElementById('createVmBtn');
  const handleVmsBtn = document.getElementById('handleVmsBtn');
  const disabledInfo = document.getElementById('disabledInfo');
  
  createVmBtn.disabled = true;
  handleVmsBtn.disabled = true;
  createVmBtn.title = 'Validate project first';
  handleVmsBtn.title = 'Validate project first';
  disabledInfo.style.display = 'block';
  
  console.log('‚ùå Buttons disabled');
}

// Open Create VM page
function openCreateVmPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Create VM page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const createVmUrl = `create_vm.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  //window.location.href = createVmUrl;
  
  // Alternative: Open in new tab
  window.open(createVmUrl, '_blank');
}

// Open Handle VMs page
function openHandleVmsPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Handle VMs page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const handleVmsUrl = `handle_vms.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  // window.location.href = handleVmsUrl;
  
  // Alternative: Open in new tab
  window.open(handleVmsUrl, '_blank');
}

// Open Create Volume page
function openCreateVolumePage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Create Volume page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const createVolumeUrl = `create_volume.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  //window.location.href = createVmUrl;
  
  // Open in new tab
  window.open(createVolumeUrl, '_blank');
}

// Open Handle Volume page
function openHandleVolumesPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Handle Volumes page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const handleVolumesUrl = `handle_volumes.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  // window.location.href = handleVmsUrl;
  
  // Open in new tab
  window.open(handleVolumesUrl, '_blank');
}


// Extract project ID from URL if provided
function initializeFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const projectIdFromUrl = urlParams.get('project_id');
  
  if (projectIdFromUrl) {
    document.getElementById('projectId').value = projectIdFromUrl;
    console.log('üìç Project ID from URL:', projectIdFromUrl);
  }
}

// Initialize on page load
window.addEventListener('load', () => {
  console.log('‚úÖ Project Panel loaded');
  initializeFromUrl();
});

// // Widget toggle functionality
// const widget = document.getElementById('learning-widget');
// const toggle = document.getElementById('widget-toggle');
// const panel = document.getElementById('widget-panel');

// toggle.addEventListener('click', () => {
//   const isExpanded = panel.style.display === 'block';
//   panel.style.display = isExpanded ? 'none' : 'block';
//   widget.classList.toggle('collapsed');
  
//   // Hide badge after first interaction
//   if (!isExpanded) {
//     localStorage.setItem('helpWidgetSeen', 'true');
//     document.getElementById('widget-badge').style.display = 'none';
//   }
// });

// // Hide badge if previously seen
// if (localStorage.getItem('helpWidgetSeen')) {
//   document.getElementById('widget-badge').style.display = 'none';
// }

// // Close panel when clicking outside
// document.addEventListener('click', (e) => {
//   if (!widget.contains(e.target) && panel.style.display === 'block') {
//     panel.style.display = 'none';
//   }
// });

</script>

</body>
</html>