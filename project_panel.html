<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Cloud - Project Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
</head>

<body>
<!-- Top Navigation Bar -->


<!-- Top Navigation Bar -->
<!-- <nav class="top-nav">
  <div class="container">
    <div style="display: flex; align-items: center; gap: 12px;">
      <a href="https://www.hbku.edu.qa" target="_blank" aria-label="Hamad Bin Khalifa University home">
        <img src="https://commons.wikimedia.org/wiki/Special:FilePath/HBKU_logo.svg"
             alt="HBKU logo"
             class="logo" />
      </a>
    </div>
    <div class="links">
      <a href="https://www.hbku.edu.qa" target="_blank">HBKU</a>
      <a href="https://rccg.hbku.edu.qa/wiki/Main_Page" target="_blank">RCCG</a>
    </div>
  </div>
</nav> -->
<div class="container">
  <div class="card mx-auto">

    <div class="card-header">
      <h2 class="mb-0">üöÄ GPU Cloud Dashboard</h2>
      <small>Project Management</small>
    </div>

    <div class="card-body">
      
      <!-- Project ID Input -->
      <!-- <div class="input-group"> -->
      <div class="mb-3">
        <label for="projectId" class="form-label"><strong>Project ID</strong></label>
        <input type="text" 
               id="projectId" 
               class="form-control" 
               placeholder="Enter your project ID"
               onkeypress="handleEnter(event)">
      </div>

      <!-- Check Project Status Button -->
      <button class="btn btn-primary w-100" onclick="checkProjectStatus()">
        <span id="checkBtn-text">üîç Check Project Status</span>
        <span id="checkBtn-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
      </button>

      <!-- Status Message -->
      <div id="status-message"></div>

      <!-- Project Info Display -->
      <div id="project-info" class="project-info">
        <div id="project-info-content"></div>
      </div>

      <!-- Action Buttons (Create VM / Handle VMs) -->
      <div class="button-group">
        <button class="btn btn-success" 
                id="createVmBtn" 
                onclick="openCreateVmPage()" 
                disabled
                title="Validate project first">
          ‚ûï Create VM
        </button>
        <button class="btn btn-info" 
                id="handleVmsBtn" 
                onclick="openHandleVmsPage()" 
                disabled
                title="Validate project first">
          ‚öôÔ∏è Manage VMs
        </button>
      </div>

      <div class="btn-disabled-info" id="disabledInfo">
        ‚ÑπÔ∏è Validate your project ID first
      </div>

    </div>

    <div class="card-footer text-center bg-white">
      <img src="https://commons.wikimedia.org/wiki/Special:FilePath/HBKU_logo.svg"
          alt="HBKU Logo"
          style="height: 60px; width: auto;">
    </div>
  </div>

<!-- <footer class="text-center py-3 mt-4 border-top">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</footer>
</div> -->

<!-- Footer -->
<div class="footer">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page" target="_blank">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// State management
let projectState = {
  projectId: null,
  isValid: false,
  projectData: null
};

// Show loading spinner on button
function setButtonLoading(isLoading) {
  const btn = document.querySelector('button[onclick="checkProjectStatus()"]');
  const spinner = document.getElementById('checkBtn-spinner');
  const text = document.getElementById('checkBtn-text');
  
  if (isLoading) {
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    text.style.opacity = '0.7';
  } else {
    btn.disabled = false;
    spinner.style.display = 'none';
    text.style.opacity = '1';
  }
}

// Display project info
// function displayProjectInfo(data, isSuccess) {
//   console.log('CheckStatuspayload:', data);
//   const infoDiv = document.getElementById('project-info');
//   const contentDiv = document.getElementById('project-info-content');
  
//   if (isSuccess) {
//     infoDiv.classList.add('success');
//     infoDiv.classList.remove('error');
//     contentDiv.innerHTML = `
//       <strong>‚úÖ Project Valid</strong>
//       <hr style="margin: 8px 0;">
//       <small>
//         <div><strong>Project Name:</strong><big> <span class="badge bg-success"> ${data.project_name} </big></span></div>
//         <div><strong>Project Responsible:</strong> ${data.pi_name}</div>
//         <div><strong>Project ID:</strong> ${data.project_id}</div>
//         <div><strong>Status:</strong> ${data.status || 'Active'}</div>
//         <div><strong>Remaining Credits:</strong> $${((data.credits ?? 0) - (data.used_credits ?? 0)).toFixed(2)}</div>
//       </small>
//     `;
//   } else {
//     infoDiv.classList.add('error');
//     infoDiv.classList.remove('success');
//     if (data.error == "not_existing") {
//       contentDiv.innerHTML = `
//         <strong>‚ùå Project Not Found</strong>
//         <hr style="margin: 8px 0;">
//         <small>The project ID you entered is not valid. Please check and try again.</small>
//       `;
//     } else {
//       contentDiv.innerHTML = `
//         <strong>üí∞‚ùå No Credits Remaining</strong>
//         <hr style="margin: 8px 0;">
//         <small>The project ID you entered has ran out of credits. Please contact RCCG.</small>
//       `;
//     }
//   }
  
//   infoDiv.classList.add('visible');
// }


// Check project status
async function checkProjectStatus() {
  const projectIdInput = document.getElementById('projectId').value.trim();
  
  if (!projectIdInput) {
    showMessage('Please enter a Project ID', 'warning');
    return;
  }

  // Set loading state
  setButtonLoading(true);
  projectState.projectId = projectIdInput;

  try {
    // Call n8n webhook to validate project
    const webhookUrl = `https://nonserially-unpent-jin.ngrok-free.dev/webhook/project_id_check?project_id=${encodeURIComponent(projectIdInput)}`;
    
    console.log('üîç Checking project status for:', projectIdInput);

    const response = await fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_id: projectIdInput })
    });

    const responseText = await response.text();
    console.log('üì° Response:', responseText);

    let data;
    try {
      data = JSON.parse(responseText);
    } catch (e) {
      console.error('Failed to parse JSON:', responseText);
      throw new Error('Invalid response from server');
    }

    // Handle response
    if (data.success) {
      projectState.isValid = true;
      projectState.projectData = data;

      // Store both ID and name
      localStorage.setItem('currentProjectId', data.project_id);
      localStorage.setItem('currentProjectName', data.project_name || 'My Project');
      
      // Enable action buttons
      enableActionButtons();
      
      // Display project info
      displayProjectInfo(data, true);
      
      // showMessage(`‚úÖ Project validated successfully!`, 'success');
      console.log('‚úÖ Project is valid:', data);
      
    } else {
      projectState.isValid = false;
      projectState.projectData = null;
      
      // Disable action buttons
      disableActionButtons();
      
      // Display error info
      displayProjectInfo(data, false);
      
      showMessage(`‚ùå Project validation failed: ${data.message || 'Unknown error'}`, 'danger');
      console.log('‚ùå Project is not valid:', data);
    }

  } catch (error) {
    console.error('Error:', error);
    projectState.isValid = false;
    disableActionButtons();
    showMessage(`Error: ${error.message}`, 'danger');
  } finally {
    setButtonLoading(false);
  }
}

function displayProjectInfo(data, isSuccess) {
  const projectInfo = document.getElementById('project-info');
  const projectInfoContent = document.getElementById('project-info-content');
  
  if (isSuccess) {
    // Calculate remaining credits
    const remainingCredits = (data.credits || 0) - (data.used_credits || 0);
    
    projectInfo.className = 'project-info visible success';
    projectInfoContent.innerHTML = `
      <strong>‚úì Project Validated</strong><br>
      <small>Project: ${escapeHtml(data.project_name || 'My Project')}</small><br>
      <small>Project Responsible:${data.pi_name}</small><br>
      <small>ID: ${escapeHtml(data.project_id)}</small><br>
      <small>Status: ${data.status || 'Active'}</small><br>
      <small>Remaining Credits: ${remainingCredits.toFixed(2)}</small>
    `;
    
    // Check if out of credits
    if (remainingCredits <= 0) {
      projectInfo.className = 'project-info visible error';
      projectInfoContent.innerHTML = `
        <strong>üí∞‚ùå Project Out of Credits</strong><br>
        <small>Project: ${escapeHtml(data.project_name || 'My Project')}</small><br>
        <small>ID: ${escapeHtml(data.project_id)}</small><br>
        <small style="color: #dc3545; font-weight: bold;">
          Credits exhausted: ${data.used_credits.toFixed(2)} / ${data.credits.toFixed(2)}
        </small><br>
        <small>Please contact RCCG to add more credits.</small>
      `;
      
      // Store credit status
      localStorage.setItem('hasCredits', 'false');
      
      // Keep buttons disabled
      disableActionButtons();
      document.getElementById('disabledInfo').innerHTML = 
        'üí∞‚ùå Project is out of credits';
      
    } else {
      // Store credit status
      localStorage.setItem('hasCredits', 'true');
    }
    
  } else {
    projectInfo.className = 'project-info visible error';
    projectInfoContent.innerHTML = `
      <strong>‚úó Validation Failed</strong><br>
      <small>${escapeHtml(data.message || 'Unknown error')}</small>
    `;
    localStorage.setItem('hasCredits', 'false');
    projectInfo.classList.add('error');
    projectInfo.classList.remove('success');
    // if (data.error == "not_existing") {
    //   projectInfoContent.innerHTML = `
    //     <strong>‚ùå Project Not Found</strong>
    //     <hr style="margin: 8px 0;">
    //     <small>The project ID you entered is not valid. Please check and try again.</small>
    //   `;
    // }
  }
}

// Enable action buttons
function enableActionButtons() {
  const createVmBtn = document.getElementById('createVmBtn');
  const handleVmsBtn = document.getElementById('handleVmsBtn');
  const disabledInfo = document.getElementById('disabledInfo');
  
  createVmBtn.disabled = false;
  handleVmsBtn.disabled = false;
  createVmBtn.title = 'Click to create a new VM';
  handleVmsBtn.title = 'Click to manage existing VMs';
  disabledInfo.style.display = 'none';
  
  console.log('‚úÖ Buttons enabled');
}

// Disable action buttons
function disableActionButtons() {
  const createVmBtn = document.getElementById('createVmBtn');
  const handleVmsBtn = document.getElementById('handleVmsBtn');
  const disabledInfo = document.getElementById('disabledInfo');
  
  createVmBtn.disabled = true;
  handleVmsBtn.disabled = true;
  createVmBtn.title = 'Validate project first';
  handleVmsBtn.title = 'Validate project first';
  disabledInfo.style.display = 'block';
  
  console.log('‚ùå Buttons disabled');
}

// Open Create VM page
function openCreateVmPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Create VM page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const createVmUrl = `create_vm.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  //window.location.href = createVmUrl;
  
  // Alternative: Open in new tab
  window.open(createVmUrl, '_blank');
}

// Open Handle VMs page
function openHandleVmsPage() {
  if (!projectState.isValid) {
    showMessage('Please validate your project first', 'warning');
    return;
  }
  
  console.log('üìÑ Opening Handle VMs page for project:', projectState.projectId);
  
  // Pass project ID to new page via URL parameter
  const handleVmsUrl = `handle_vms.html?project_id=${encodeURIComponent(projectState.projectId)}`;
  // window.location.href = handleVmsUrl;
  
  // Alternative: Open in new tab
  window.open(handleVmsUrl, '_blank');
}

// Handle Enter key on input field
function handleEnter(event) {
  if (event.key === 'Enter') {
    checkProjectStatus();
  }
}

// Extract project ID from URL if provided
function initializeFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  const projectIdFromUrl = urlParams.get('project_id');
  
  if (projectIdFromUrl) {
    document.getElementById('projectId').value = projectIdFromUrl;
    console.log('üìç Project ID from URL:', projectIdFromUrl);
    // Optionally auto-check
    // checkProjectStatus();
  }
}

// Initialize on page load
window.addEventListener('load', () => {
  console.log('‚úÖ Project Panel loaded');
  initializeFromUrl();
});
</script>

<script src="utils.js"></script>
</body>
</html>