<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Cloud Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { padding: 20px; background-color: #f8f9fa; }
    .container { max-width: 600px; margin-top: 50px; }
    button { margin: 5px; }
    .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #status-message { margin-top: 20px; }

    #progress-panel .alert {
      background-color: #d1ecf1 !important; /* Bootstrap's light blue */
      color: #0c5460 !important;            /* Bootstrap's blue text */
      border-left: 4px solid #0c5460;
    }

    #progress-panel table,
    #progress-panel td,
    #progress-panel th {
      background-color: transparent !important;
    }
    #feedback-panel .card {
      border-width: 2px;
      margin-top: 20px;
      animation: slideDown 0.3s ease-out;
    }

    #feedback-panel .card-header {
      font-size: 1.1rem;
      padding: 12px 16px;
    }

    #feedback-panel .card-body {
      padding: 20px;
      background-color: #bea9f1;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #markdown-panel .card-body {
      background: #f8f9fa;
      font-size: 1rem;
      padding: 1rem;
    }

    #markdown-panel .card-header {
      background-color: #6f42c1;   /* Bootstrap purple */
      color: #fff;                 /* White text */
      /* border-bottom: 2px solid #4b286d; Darker purple border */
      border: 2px solid #6f42c1;
    }

    #markdown-panel {
      border: 2px solid #6f42c1;   /* Match header color or choose another */
    }
  </style>
</head>
<body>
<!-- <div class="container mt-4" style="max-width: 400px;"> </div> -->
<div class="container">
  <div class="card">
    <div class="card-body">
      <h2 class="card-title">GPU Cloud Control</h2>

      <div class="card p-3 mb-3">
        <h5>Project Panel</h5>
        <div class="mb-3">
          <label for="project_id" class="form-label">Project ID</label>
          <input type="text" id="project_id" class="form-control" placeholder="Enter your Project ID">
        </div>

        <button class="btn btn-secondary" onclick="trigger('project_status')">üîç Project Status</button>

        <div id="project-panel" class="mt-3">
          <div id="project-content" class="alert alert-info" role="alert">
            Your existing VMs will appear here.
          </div>
        </div>

        <button id="credit_btn" onclick="trigger('show_credits')" class="btn btn-info" disabled>üí∞ Show Credit Usage/button>
        <button id="create_btn" onclick="trigger('create_vm')" class="btn btn-primary" disabled>‚ñ∂Ô∏è Create GPU VM</button>
        <button id="handle_btn" onclick="trigger('handle_vms')" class="btn btn-warning" disabled>‚è∏Ô∏è Handle GPU VMs</button>
      </div>
    </div>
  </div>
</div>

<script>

// Initialize Supabase client
const supabaseUrl = 'https://dgttklfdlwaxvxjubcxx.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRndHRrbGZkbHdheHZ4anViY3h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTkzNTAsImV4cCI6MjA3NDI5NTM1MH0.ZggUBEE_GN0e_-b4TQL8yaXfe5ckoD6AglORC7NdYwQ';
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);


function showMessage(message, type = 'info') {
  const statusDiv = document.getElementById('status-message');
  statusDiv.innerHTML = `<div class="alert alert-${type} mt-3" role="alert">${message}</div>`;
  setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
}

function clearMessage() {
  const progressDiv = document.getElementById('progress-content');
  progressDiv.innerHTML = '';
  const detailsDiv = document.getElementById('markdown-content');
  detailsDiv.innerHTML = '';
}


function showProgress(message, type = 'info', action = '') {
  const progressDiv = document.getElementById('progress-content');
  progressDiv.className = `alert alert-${type}`;
  progressDiv.innerHTML = message;
  if (action) addToHistory(action, message, type);
}

function showDetails(msg) {
  const markdownDiv = document.getElementById('markdown-content');
  let markdownText = '';

  try {
    // Try to parse as JSON and extract 'message' field
    const data = typeof msg === 'string' ? JSON.parse(msg) : msg;
    if (data.message) {
      markdownText = data.message;
    } else {
      // If no 'message' field, fallback to stringified object
      markdownText = JSON.stringify(data, null, 2);
    }
  } catch (e) {
    // If not JSON, treat msg as markdown/text
    markdownText = msg;
  }

  // Parse markdown and display
  markdownDiv.innerHTML = marked.parse(markdownText);
}

function getActionLabel(action) {
  const labels = {
    'run_simulation': '‚ñ∂Ô∏è Starting Simulation',
    'pause_simulation': '‚è∏Ô∏è Pausing Simulation',
    'resume_simulation': 'üîÅ Resuming Simulation',
    'stop_simulation': 'üõë Stopping Simulation',
    'get_workflow_status': 'üîç Checking Status',
    'show_credits': 'üí∞ Credit Information'
  };
  return labels[action] || action;
}



function showSpinner() {
  document.getElementById('loading-spinner').style.display = 'block';
}

function hideSpinner() {
  document.getElementById('loading-spinner').style.display = 'none';
}

let webhook_response = null;

const create_btn = document.getElementById('create_btn');

async function trigger(action) {
  clearMessage();
  showSpinner(); // Show spinner when request starts
  const projectId = document.getElementById('project_id').value.trim();
  if (!projectId) {
    showProgress('Please enter a Project ID', 'warning');
    hideSpinner();
    return;
  }

  //Initial check of Project ID
  const initialRequestIDCheck = `https://nonserially-unpent-jin.ngrok-free.dev/webhook/project_id_check?project_id=${encodeURIComponent(project_id)}`;
  console.log('Attempting to process Project ID:', projectId);
  try {
    const response = await fetch(initialRequestIDCheck, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ project_id: projectId })
    });
    const check_msg = await response.text();
    try {
      data = JSON.parse(check_msg);
    } catch (e) {
      console.error('Response is not valid JSON:', e);
      return;
    }
    if (data.success === true) {
      console.log('Poject ID is valid');
      //proceed with the rest of the code
      info.textContent = `‚úÖ Project ID: ${projectId}`;
      actions.classList.remove("d-none");

      // Wire buttons
      document.getElementById("handleBtn").onclick = () =>
      window.location.href = `handle_vms.html?project_id=${projectId}`;
      document.getElementById("createBtn").onclick = () =>
      window.location.href = `create_vm.html?project_id=${projectId}`;
    } else {
      hideSpinner();
      console.log('Project ID is not valid');
      info.textContent = `‚ùå Invalid Project ID`;
      // showProgress(`Error: ${err.message}`, 'danger');
      showProgress(`Error: Request ID is not valid`, 'danger');
      return;
    }
  } catch (err) {
    console.error('Check status error:', err);
    showProgress(`Error: ${err.message}`, 'danger');
    return;
  }

  // üî• Start listening for real-time updates
  if (action === 'run_simulation_simple' || action === 'pause_simulation' || action === 'stop_simulation') {
    subscribeToStatusUpdates(requestId, action);
  }

  const webhookUrl = `https://nonserially-unpent-jin.ngrok-free.dev/webhook/${action}?request_id=${encodeURIComponent(requestId)}`;
  console.log('Attempting to process Request ID:', requestId);

  if (action === 'check_status') {
    try {
      const response = await fetch(webhookUrl, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request_id: requestId })
      });
      const check_msg = await response.text();
      const data = JSON.parse(check_msg);
      const check_message = `STATUS = ${data.request_status} started by ${data.user_name} at ${new Date(data.first_time_start).toLocaleString('en-US')}`;

      showProgress(`STATUS = ${data.request_status}`, 'info');
      const showProgressDiv = document.getElementById('markdown-content');
      showProgressDiv.innerHTML = check_message;
      addToHistory(action, check_message, 'info');
      hideSpinner();
    } catch (err) {
      console.error('Check status error:', err);
      showProgress(`Error: ${err.message}`, 'danger');
    }
  } else { //Trigger is not Check Status
    // Fire and forget - don't await this
    fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: requestId })
    })
      .then(response => response.text())
      .then(msg => {
        console.log('Webhook initial response:', msg);
        showDetails(msg);
      })
      .catch(err => {
        console.error('Webhook error:', err);
        hideSpinner();
      })
  }
}

// Real-time updates via Supabase
let activeChannel = null; // Track active subscription

function subscribeToStatusUpdates(requestId, action) {
  // Unsubscribe from any previous channel
  if (activeChannel) {
    activeChannel.unsubscribe();
  }
  
  console.log('Subscribing to updates for Request ID:', requestId);
  
  // Create new channel
  activeChannel = supabase
    .channel(`status-updates-${requestId}`)
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'vm_creation_requests',
        filter: `form_submission_unique_id=eq.${requestId}`
      },
      (payload) => {
        console.log('‚ú® Real-time update received:', payload.new);
        handleRealtimeUpdate(payload.new, action);
      }
    )
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        console.log('‚úÖ Subscribed to real-time updates');
        // showMessage('üì° Monitoring status in real-time...', 'info');
        showProgress('üì° Monitoring status in real-time...', 'info');
      }
    });
    
  // Auto-unsubscribe after 30 minutes (optional cleanup)
  setTimeout(() => {
    if (activeChannel) {
      activeChannel.unsubscribe();
      hideSpinner();
      console.log('Unsubscribed after timeout');
    }
  }, 1800000); // 30 minutes
}

function handleRealtimeUpdate(data, action) {
  // Format the update as a nice message
  const statusMessage = formatStatusUpdate(data);
  
  // Update feedback panel with new status
  // showFeedbackPanel(JSON.stringify(data), 'success', `Status: ${data.request_status}`);
  // showFeedback(JSON.stringify(data), 'success', `Status: ${data.request_status}`);
  showProgress(formatResponseData(data, 'status_update'), 'success', `Status: ${data.request_status}`);
  
  // // Show toast notification
  // showMessage(statusMessage, 'success');
  
  // Check if workflow is complete
  if (action === 'run_simulation_simple' && data.request_status === 'simulation_running') {
    showMessage('‚úÖ Workflow completed!', 'success');
    // showProgress('‚úÖ Workflow completed!', 'success');
    hideSpinner();
    // Unsubscribe since workflow is done
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    } 
  } else if (action === 'stop_simulation' && data.request_status === 'finalized') {
    showMessage('‚úÖ Workflow completed!', 'success');
    // showProgress('‚úÖ Workflow completed!', 'success');
    hideSpinner();
    // Unsubscribe since workflow is done
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    }  
  } else if (data.request_status === 'failed') {
    showMessage('‚ùå Failed to copy', 'failed');
    // showProgress('‚úÖ Workflow completed!', 'success');
    hideSpinner();
    // Unsubscribe since workflow is done
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    }
  }

}


function formatStatusUpdate(data) {
  const statusEmojis = {
    'processing': '‚è≥',
    'provisioning_vm': 'üîÑ',
    'vm_ready': '‚úÖ',
    'uploading_data': 'üì§',
    'simulation_running': 'üöÄ',
    'simulation_complete': '‚úÖ'
  };
  
  const status = data.STATUS || data.workflow_status;
  const emoji = statusEmojis[status] || '‚ÑπÔ∏è';
  return `${emoji} ${status}`;
}

</script>
</body>
</html>
