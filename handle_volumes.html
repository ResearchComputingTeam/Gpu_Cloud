<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Existing Volumes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <link href="css/style.css" rel="stylesheet">
</head>

<body>

<div class="main-wrapper">
  <!-- Workflow Sidebar -->
  <leftside>
    <div class="workflow-sidebar mb-3">
      <h6 class="mb-3"><strong>Volume Management</strong></h6>

      <div class="workflow-step active" onclick="showHelp('check')">
        <div class="icon">üîç</div>
        <div>Check Status</div>
      </div>
    
      <div class="workflow-step" onclick="showHelp('attach')">
        <div class="icon">üîó</div>
        <div>Attach to VM</div>
      </div>

      <div class="workflow-step" onclick="showHelp('mount')">
        <div class="icon">üíø</div>
        <div>Mount Volume</div>
      </div>

      <div class="workflow-step" onclick="showHelp('unmount')">
        <div class="icon">‚èèÔ∏è</div>
        <div>Unmount Safely</div>
      </div>

      <div class="workflow-step" onclick="showHelp('detach')">
        <div class="icon">üîå</div>
        <div>Detach From VM</div>
      </div>

      <div class="workflow-step" onclick="showHelp('transfer')">
        <div class="icon">üîÑ</div>
        <div>Transfer Between VMs</div>
      </div>

      <div class="workflow-step" onclick="showHelp('delete')">
        <div class="icon">üóëÔ∏è</div>
        <div>Delete Volume</div>
      </div>

    </div>
  </leftside>

  <!-- Main Content -->
  <main class="main-content">
    <nav class="breadcrumbs" aria-label="breadcrumb">
      <ol>
        <li><a href="project_panel.html">üè† Home</a></li>
        <li class="active">Manage Volumes</li>
      </ol>
    </nav>
    <!-- Main Card -->
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-0">üíæManage Volumes</h2>
          <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 1rem; display: inline-flex; align-items: center; gap: 6px;">
              <span style="font-size: 1.2rem;">üìÇ</span>
              <span id="projectNameDisplay">Loading...</span>
            </span>
            <small style="opacity: 0.75;">
              <code class="text-white" id="projectIdDisplay" style="font-size: 0.85rem;">Loading...</code>
            </small>
          </div>
        </div>
        <div class="d-flex gap-1">
          <!-- Documentation Links -->
          <div class="btn-group" role="group">
            <a href="documentation.html" class="btn btn-outline-light btn-sm" target="_blank" title="Complete User Guide">
              üìñ Docs
            </a>
            <a href="cheatsheet.html" class="btn btn-outline-light btn-sm" target="_blank" title="Quick Reference">
              ‚ö° Cheat Sheet
            </a>
          </div>
          <button class="btn btn-light btn-sm" onclick="goBackToProjectPanel()">‚Üê Back</button>
        </div>
      </div>
    </div>
    <div class="card-body" style="background:white; padding: 5px;">
      <!-- Volumes List Card -->
      <div class="card" style="margin-bottom: 5px; box-shadow: none; border: 1px solid #757de7;">
        <div class="card-header" style="background: #757de7; padding: 6px 6px; line-height: 1.1;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0">Volumes (<span id="volumeCount">0</span>)</h6>
            </div>
            <!-- Refresh Button -->
            <button id="refreshVolumesButton"  class="btn btn-primary btn-sm" style="width: fit-content;" onclick="loadVolumes()">
                <span id="refreshVolumeBtn-text">üîÑ Refresh Volumes</span>
                <!-- <span id="refreshBtn-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span> -->
            </button>
          </div>
        </div>
        <div id="volumesList" style="max-height: 220px; min-height: 220px; overflow-y: auto; padding: 0;">
          <div class="text-center text-muted p-3">
            <p class="text-center mt-0 mb-0 fs-5">Loading Volumes...</p>
            <div class="empty-state-icon" style="font-size: 2.5rem;">‚è≥</div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2 mb-0">
        <input type="hidden" id="volumeName" value=""> 
        <p id="volumeSelectedDisplay" class="alert alert-info text-center mb-0 p-2" style="display:none;">
            Volume Selected: <strong><span id="selectedVolumeName"></span></strong>
        </p>
      </div>

      <div class="d-grid gap-2" id="volumeActionButtons">
          <div class="btn-group d-flex gap-2">
              <button class="btn btn-primary" onclick="goToCreateVolumePage()">‚ñ∂Ô∏è Create Volume</button>
          </div>
          <button id="deleteVolumeButton" class="btn btn-danger">üóëÔ∏è Delete Volume</button>
      </div>
    </div>

    <!-- Help Card (contextual) -->
    <div class="help-card mt-3" id="helpCard">
      <div id="helpContent">
        <strong>üîç Check Volume Status</strong>
        <p class="mb-0 mt-2">Select a Volume from the list below to view its current status and details.</p>
      </div>
    </div>

  </main>

  <rightside>
     <div id="progress-panel" class="card mt-1" style="box-shadow: none; border: 1px solid #757de7;">
      <div class="card-header" style="background: #757de7; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">üß© Progress</h6>
        </div>
      </div>
      <div class="card-body" style="max-height: 160px; overflow-y: auto; padding: 0;">
          <div id="progress-content" class="alert alert-info" role="alert">
            Ready, waiting for user action.
          </div>
      </div>
    </div>

    <div id="status-message"></div>

    <div class="card mt-4" style="box-shadow: none; border: 1px solid #7e3baa;">
      <div class="card-header" style="background: #7e3baa; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üîç Details</h6>
          </div>
        </div>
      </div>

      <div class="card-body p-3" id="markdown-volume">
          <!-- Rendered markdown HTML goes here -->
      </div>
    </div>
  
    <div id="errorCard" class="card mt-4" style="display:none; box-shadow: none; border: 1px solid #e74a4a;">
      <div class="card-header" style="background: #e74a4a; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üö´ Errors</h6>
          </div>
        </div>
      </div>
      <div id="errorPanel" style="max-height: 100px; overflow-y: auto; padding: 0;">
        <div class="text-center text-muted p-3">
        </div>
      </div>
    </div>
  </rightside>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ‚ö†Ô∏è Are you sure you want to <strong>delete this Volume</strong>?<br>
        This action <strong>cannot be undone</strong>.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, delete it</button>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<!-- <div class="footer">
  <small class="text-muted">
    Powered by <a href="https://rccg.hbku.edu.qa/wiki/Main_Page" target="_blank">RCCG</a> | 
    Hamad Bin Khalifa University | 
    <a href="mailto:rccg@hbku.edu.qa">Support</a>
  </small>
</div> -->

<script>

let projectId = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('Handle Volumes page loaded');
  // check if user is allowed
  currentUser = await requireAuth();
  if (!currentUser) {
    showMessage('You are not logged-in as an authenticated user', 'danger');
    return;
  }
  
  // Load project info
  projectId = getProjectIdFromUrl();
  console.log('Project ID=', projectId);
  const projectName = await getProjectNameFromSupabase(projectId);
  console.log('Project Name:', projectName);
  
  document.getElementById('projectIdDisplay').textContent = projectId;
  document.getElementById('projectNameDisplay').textContent = projectName;

  if (!projectId) {
    showMessage('No project ID provided', 'danger');
    return;
  }

  // Check credits
  const hasCredits = checkCredits(projectId);
  
  if (!hasCredits) {
    console.log('üí∞‚ùå Project is out of credits - interface disabled');
  } else {
    console.log('‚úÖ Project has credits - interface enabled');
  }
  
  // Load Volumes
  await loadVolumes();
});

// Help content for each action
const helpContent = {
  check: {
    title: 'üîçCheck Volume Status',
    content: `<p>View volume details, attachment status, and usage information.</p>
    <p><strong>Volume States:</strong></p>
    <table class="table table-sm table-bordered">
      <tr><td><span class="badge bg-success">AVAILABLE</span></td><td>Ready to attach</td></tr>
      <tr><td><span class="badge bg-info">IN-USE</span></td><td>Attached to a VM</td></tr>
      <tr><td><span class="badge bg-danger">DELETED</span></td><td>Has been removed</td></tr>
    </table>
    <p><strong>‚ö†Ô∏èImportant Info:</strong></p>
    <ul class="mb-0">
      <li> Persistent, network-based SSDs that retain data across VM lifecycles. Each VM can attach up to 10 volumes.</li>
      <li><strong>Size:</strong> Cannot be rezised after creation</li>
      <li><strong>Cost:</strong> $0.097/TB/hour (~$70/TB/month)</li>
      <li>Management is not automatic. You need to mount them at VM startup/restore and unmont them <strong>before</strong> VM hibernate/delete ‚á® More details in <strong> Volume Handling </strong> section </li>
      <li><strong>Device path:</strong> Shown in "Manage VMs" page UI after attachment</li>
    </ul>`
  },
  attach: {
    title: 'üîóAttach Volume to VM',
    content: `<p><strong>Steps to attach:</strong></p>
    <ol>
      <li>Select volume from list above</li>
      <li>Ensure volume is <strong>AVAILABLE</strong> (not attached elsewhere)</li>
      <li>Go to <strong>Manage VMs</strong></li>
      <li>Select the VM you want to attach the volume to</li>
      <li>In the <strong>Details</strong> section, click <strong>Attach Volume</strong></li>
      <li>Choose the target Volume from list</li>
      <li>Click on <strong>Attach Volume</strong></li>
      <li>Note the device path shown in UI</li>
    </ol>
    <p><strong>Important Notes:</strong></p>
    <ul>
      <li>Volume can only be attached to <strong>ONE VM at a time</strong></li>
      <li>VM must be in <strong>ACTIVE (running)</strong> state</li>
      <li>Each VM supports up to <strong>10 volumes</strong></li>
      <li>Copy the <strong>device path</strong> from UI for mounting</li>
    </ul>
    <p><strong>Device Path Example:</strong></p>
    <div class="cmd-block" style="background:#f8f9fa; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code>/dev/disk/by-id/virtio-c72d3b45-dc19-48ec-9</code>
    </div>
    <p class="mb-0"><strong>üí°Tip:</strong> Use the <strong>Copy Device</strong> button in UI!</p>`
  },
  mount: {
    title:'üíøMount Volume on VM',
    content: `<p><strong>After attaching in UI, SSH to VM and mount:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code># 1. Copy device path from UI<br>
      DEVICE="/dev/disk/by-id/virtio-c72d3b45-dc19-48ec-9"<br><br>
      # 2. Verify device exists<br>
      ls -l \${DEVICE}<br>
      lsblk<br><br>
      # 3. Format (FIRST TIME ONLY! Erases data!)<br>
      sudo mkfs.ext4 -F \${DEVICE}<br><br>
      # 4. Create mount point<br>
      sudo mkdir -p /mnt/user_volume<br><br>
      # 5. Mount the volume<br>
      sudo mount \${DEVICE} /mnt/user_volume<br><br>
      # 6. Verify mounted<br>
      df -h | grep user_volume<br>
      ls -la /mnt/user_volume</code>
    </div>
    <p><strong>‚ö†Ô∏èWarning:</strong> Only run <code>mkfs.ext4</code> on brand new volumes! It erases all data.</p>
    <p><strong>Auto-mount on boot (optional):</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code># Get UUID<br>
      sudo blkid \${DEVICE}<br><br>
      # Edit fstab<br>
      sudo nano /etc/fstab<br>
      # Add line (replace UUID):<br>
      UUID=your-uuid /mnt/user_volume ext4 defaults,nofail 0 2<br><br>
      # Test<br>
      sudo mount -a</code>
    </div>
    <p class="mb-0"><strong>üí°Tip:</strong> Use <code>nofail</code> option if volume isn't always attached!</p>`
  },
  unmount: {
    title: '‚èèÔ∏èUnmount Volume Safely',
    content: `<p><strong>‚ö†Ô∏èCRITICAL: Always unmount before detaching in UI!</strong></p>
    <p><strong>Safe unmount procedure:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code># 1. Check what's using the volume<br>
      lsof /mnt/user_volume<br>
      fuser -m /mnt/user_volume<br><br>
      # 2. Stop processes if needed<br>
      # (Exit programs, kill processes)<br><br>
      # 3. Flush all pending writes<br>
      sync<br><br>
      # 4. Unmount<br>
      sudo umount /mnt/user_volume<br><br>
      # 5. Verify unmounted<br>
      df -h | grep user_volume  # Should show nothing<br>
      mount | grep user_volume   # Should show nothing</code>
    </div>
    <p><strong>If unmount fails:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code># Force unmount (use with caution!)<br>
      sudo umount -f /mnt/user_volume<br><br>
      # Or lazy unmount<br>
      sudo umount -l /mnt/user_volume</code>
    </div>
    <p class="mb-0"><strong>‚ö†Ô∏èNever detach without unmounting - can cause data corruption!</strong></p>`
  },
  detach: {
    title: 'üîåDetach Volume from VM',
    content: `<p><strong>Complete detach procedure:</strong></p>
    <ol>
      <li><strong>On VM:</strong> Unmount volume safely (see Unmount section)</li>
      <li><strong>Verify:</strong> <code>df -h | grep user_volume</code> shows nothing</li>
      <li>In "Manage VMs" page, go to VM details</li>
      <li>Find attached volumes section</li>
      <li>Click <strong>Detach</strong></li>
      <li><strong>Wait:</strong> Volume status changes to AVAILABLE</li>
    </ol>
    <p><strong>After detaching:</strong></p>
    <ul>
      <li>Volume can be attached to another VM</li>
      <li>All data is preserved</li>
      <li>No need to format again</li>
      <li>Storage charges continue</li>
    </ul>
    <p><strong>Quick verification:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code># On VM (after detach)<br>
      lsblk  # Should not show the volume<br>
      ls -l /dev/disk/by-id/virtio-*  # Device gone</code>
    </div>
    <p class="mb-0"><strong>üí°Use Case:</strong> Moving data between VMs without re-uploading!</p>`
  },
  transfer: {
    title: 'üîÑTransfer Volume Between VMs',
    content: `<p><strong>Moving a volume from VM-A to VM-B:</strong></p>
    <div class="workflow-step" style="display:flex; align-items:start; margin:8px 0;">
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0; margin-right:10px; font-size:0.85rem;">1</div>
      <div><strong>On VM-A:</strong> Unmount the volume
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:6px; border-radius:4px; margin:6px 0; font-size:0.8rem;">
          <code>sync<br>sudo umount /mnt/user_volume</code>
        </div>
      </div>
    </div>
    <div class="workflow-step" style="display:flex; align-items:start; margin:8px 0;">
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0; margin-right:10px; font-size:0.85rem;">2</div>
      <div><strong>In UI:</strong> Detach from VM-A</div>
    </div>
    <div class="workflow-step" style="display:flex; align-items:start; margin:8px 0;">
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0; margin-right:10px; font-size:0.85rem;">3</div>
      <div><strong>In UI:</strong> Wait for status = AVAILABLE</div>
    </div>
    <div class="workflow-step" style="display:flex; align-items:start; margin:8px 0;">
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0; margin-right:10px; font-size:0.85rem;">4</div>
      <div><strong>In UI:</strong> Attach to VM-B</div>
    </div>
    <div class="workflow-step" style="display:flex; align-items:start; margin:8px 0;">
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0; margin-right:10px; font-size:0.85rem;">5</div>
      <div><strong>In UI:</strong> Copy new device path for VM-B</div>
    </div>
    <div class="workflow-step" style="display:flex; align-items:start; margin:8px 0;">
      <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; flex-shrink:0; margin-right:10px; font-size:0.85rem;">6</div>
      <div><strong>On VM-B:</strong> Mount with new device path
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:6px; border-radius:4px; margin:6px 0; font-size:0.8rem;">
          <code>DEVICE="/dev/disk/by-id/virtio-new-path"<br>sudo mount \${DEVICE} /mnt/user_volume</code>
        </div>
      </div>
    </div>
    <p class="mt-2"><strong>üí°Common Use Cases:</strong></p>
    <ul class="mb-0">
      <li>Moving from staging VM to GPU VM</li>
      <li>Sharing datasets across team VMs</li>
      <li>Moving to cheaper/more powerful VM</li>
      <li>No need to re-upload data!</li>
    </ul>`
  },
  delete: {
    title:'üóëÔ∏èDelete Volume',
    content: `<p><span style="color: #dc3545;"><strong>‚ö†Ô∏èPERMANENT ACTION - ALL DATA WILL BE LOST!</strong></span></p>
    <p><strong>‚ö†Ô∏èBEFORE DELETING:</strong></p>
    <ol>
      <li><strong>Download important data</strong> to your laptop</li>
      <li><strong>Verify backups</strong> are complete</li>
      <li><strong>Unmount from VM:</strong>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:6px; border-radius:4px; margin:6px 0; font-size:0.8rem;">
          <code>sync<br>sudo umount /mnt/user_volume</code>
        </div>
      </li>
      <li><strong>Detach in UI</strong></li>
    </ol>
    <p><strong>What gets deleted:</strong></p>
    <ul>
      <li>All data on the volume</li>
      <li>Volume configuration</li>
      <li>Cannot be recovered</li>
    </ul>
    <p><strong>After deletion:</strong></p>
    <ul>
      <li>All charges stop immediately</li>
      <li>Data is permanently lost</li>
    </ul>
    <p><strong>To delete:</strong> Select volume and click <strong>üóëÔ∏èDelete Volume</strong> button.</p>
    <p class="mb-0"><strong>üí∞Cost Savings:</strong> Delete unused volumes to reduce storage costs!</p>`
  }
};

function showHelp(action, vmIp = null) {
  // ... update help content ...
  const help = helpContent[action];
  document.getElementById('helpContent').innerHTML = `
    <strong>${help.title}</strong>
    <p class="mb-0 mt-2">${help.content}</p>
  `;
  
  // Update active state
  document.querySelectorAll('.workflow-step').forEach(el => {
    el.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  // ‚úÖ Call separate function that doesn't need event
  // updateSidebarActive(action);
}

// New helper function
function updateSidebarActive(action) {
  const actionMap = {
    'check': 0,
    'create': 1,
    'volume': 2,
  };
  
  const steps = document.querySelectorAll('.workflow-step');
  steps.forEach(el => el.classList.remove('active'));
  
  const index = actionMap[action];
  if (index !== undefined && steps[index]) {
    steps[index].classList.add('active');
  }
}

function goBackToProjectPanel() {
  window.location.href = `project_panel.html?project_id=${encodeURIComponent(projectId)}`;
}

function goToCreateVolumePage() {
  // Pass project ID to new page via URL parameter
  const createVolumeUrl = `create_volume.html?project_id=${encodeURIComponent(projectId)}`;
  window.open(createVolumeUrl, '_blank');
}


document.getElementById("deleteVolumeButton").addEventListener("click", async () => {
  try {
    await deleteVolume();
  } catch (err) {
    console.error('Unhandled error in deleteVolume:', err);
    showMessage(`Unexpected error: ${err.message}`, 'danger');
  }
});

function selectVolume(volumeName) {
    // 1. Update the hidden input field (volumeName)
    document.getElementById('volumeName').value = volumeName;

    // 2. Update the visual display
    document.getElementById('selectedVolumeName').textContent = volumeName.replace(/_[^_]*$/, '');
    document.getElementById('volumeSelectedDisplay').style.display = 'block';

    // 3. Highlight the selected item in the list
    const listItems = document.querySelectorAll('#volumesList .list-group-item');
    listItems.forEach(item => {
        item.classList.remove('selected');
    });

    // Find and highlight the specific item
    const selectedItem = document.querySelector(`[data-volume-name="${volumeName}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }

    // 4. Enable the action buttons
    document.querySelectorAll('#volumeActionButtons button').forEach(button => {
        button.disabled = false;
    });

    // Optional: Pre-fill status check
    CheckVolumeStatus(volumeName); 
}

async function deleteVolume() {
  const volumeNameInput = document.getElementById('volumeName').value.trim();
  if (!volumeNameInput) {
    showMessage('Please enter a Volume Name', 'warning');
    return;
  }

  const deleteModalEl = document.getElementById('confirmDeleteModal');
  const deleteModal = new bootstrap.Modal(deleteModalEl);

  // Replace button to avoid stacked listeners
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  confirmDeleteBtn.replaceWith(confirmDeleteBtn.cloneNode(true));
  const newConfirmDeleteBtn = document.getElementById('confirmDeleteBtn');

  // // Handle deletion
  newConfirmDeleteBtn.addEventListener('click', async () => {
    const deleteVolumeButton = document.getElementById('deleteVolumeButton');
    const originalHTML = deleteVolumeButton.innerHTML;

    try {
      // Close modal
      deleteModal.hide();

      // Disable and show spinner on main button
      deleteVolumeButton.disabled = true;
      deleteVolumeButton.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Deleting Volume...
      `;

      // Perform delete action
      await triggerDeleteAction({ volume_name: volumeNameInput });

      showMessage('Volume deleted successfully', 'success');
    } catch (err) {
      console.error('Error deleting Volume:', err);
      showMessage('Failed to delete Volume', 'danger');
    } finally {
      // Restore button
      deleteVolumeButton.disabled = false;
      deleteVolumeButton.innerHTML = originalHTML;
    }
  });

  // Show the modal
  deleteModal.show();

  // üî¥ FIX: Ensure UI is fully restored when modal is hidden
  deleteModalEl.addEventListener('hidden.bs.modal', () => {
    // Remove the class that disables scrolling
    document.body.classList.remove('modal-open');

    // Remove the backdrop manually if it‚Äôs still there
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
  });
}



async function triggerDeleteAction(volumeName) {

  const payload = { ...volumeName, project_id: projectId };

  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/delete_volume`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);
    showProgress("Volume deletion is starting", 'info', 'delete_volume');
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.message || 'Action failed');
    }
    
    showProgress("Volume deletion started", 'info', 'delete_volume');
    CheckVolumeStatus(volumeName.volume_name);
    console.log('Response received:', data);
    
    if (data.success) {
      showProgress('VM deletion is over', 'info', 'vm_deleted');
      // CheckVolumeStatus(volumeName.user_vm_name);
      loadVolumes();
      displayVmDetails(data);
      return;
    } else {
        showProgress(`Volume deletion failed: ${data.message || 'Unknown error'}`, 'danger', 'delete_vm');
        showError(JSON.stringify(data));
        throw new Error(data.message || 'Action failed');
    }
    
  } catch (error) {
    console.error('Error:', error);
    showProgress(`Error: ${error.message}`, 'danger', 'delete_vm');
    showError(error.message);
    throw error; // Re-throw so caller knows it failed
  }
}

async function CheckVolumeStatus(volumeName) {
  console.log('CheckVolumeStatus called on', volumeName);
  const payload = { volume_name: volumeName };

  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/check_volume_status`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    console.log('Response received:', data);
    
    if (data.success) {
      //Display the volume details
      displayVolumeDetails(data);
      // document.getElementById('loading-spinner').style.display = 'none';
    } else {
      showProgress(`‚ùåVolume listing failed: ${data.message || 'Unknown error'}`, 'danger', 'list_volumes');
      document.getElementById('volumesList').innerHTML = '<div class="text-danger p-3">Failed to load Volumes</div>';
    }
    
  } catch (error) {
    console.error('Error:', error);
    showError(error.message);
  }
}

function displayVolumesList(responseData) {
  const data = Array.isArray(responseData) ? responseData[0] : responseData;
  const volumes = data.volumes || [];
  
  document.getElementById('volumeCount').textContent = volumes.length;
  
  const volumesListDiv = document.getElementById('volumesList');
  
  if (volumes.length === 0) {
    volumesListDiv.innerHTML = '<div class="text-muted p-3">No Volumes found</div>';
    // Disable buttons if no VMs exist
    document.querySelectorAll('#volumeActionButtons button').forEach(button => {
      button.disabled = true;
    });
    document.getElementById('volumeSelectedDisplay').style.display = 'none';
    return;
  }
  
  volumesListDiv.innerHTML = `
    <div class="list-group list-group-flush">
      ${volumes.map(volume => `
        <div class="list-group-item list-group-item-action" 
              onclick="selectVolume('${escapeHtml(volume.volume_name)}')"
              data-volume-name="${escapeHtml(volume.volume_name)}"
              style="cursor: pointer;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${escapeHtml(volume.volume_name.replace(/_[^_]*$/, ''))}</strong>
              <br>
              <small class="text-muted">
                ${escapeHtml(volume.volume_size_gb) || 'N/A'}GB ‚Ä¢ $${escapeHtml(volume.volume_total_cost || 0).toFixed(2)}
              </small>
            </div>
            <span class="volume-status ${escapeHtml(volume.volume_state)}">${escapeHtml(volume.volume_state.toLowerCase())}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  // Ensure buttons are disabled until a selection is made (unless a selection was preserved)
  document.querySelectorAll('#volumeActionButtons button').forEach(button => {
      button.disabled = true;
  });
  document.getElementById('volumeSelectedDisplay').style.display = 'none';
}

async function loadVolumes() {

  // üßπ Reset / clear any previous error display
  resetErrorCard();
  clearProgressPanel();

  const refreshBtn = document.getElementById('refreshVolumesButton');
  const refreshText = document.getElementById('refreshVolumeBtn-text');

  // Disable button immediately and show spinner
  refreshBtn.disabled = true;
  const originalHTML = refreshBtn.innerHTML;

  refreshBtn.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    Refreshing Volumes...
  `;

  const payload = { project_id: projectId };

  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/list_volumes`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);
    // showProgress("VMs listing", 'info', 'list_volumes');
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    console.log('Response received:', data);
    
    if (data.success) {
      // showMessage(`üîÑ VM list updated`, 'success');
      //list the VMs
      displayVolumesList(data);
    } else {
      document.getElementById('volumesList').innerHTML = '<div class="text-secondary p-3">No VMs to display, go to "Create VM" page: <button class="btn btn-primary btn-sm" onclick="goToCreateVolumePage()">‚ñ∂Ô∏è Create VM</button></div>';
    }
    
  } catch (error) {
    console.error('Error:', error);
    showProgress(`Error: ${error.message}`, 'danger', 'list_volumes');
    showError(error.message);
  } finally {
    // 2Ô∏è‚É£ Re-enable button and restore original content
    refreshBtn.disabled = false;
    refreshBtn.innerHTML = originalHTML;
  }
}

</script>

<script src="utils.js"></script>

</body>

</html>