<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Existing VMs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="auth.js"></script>
</head>

<body>

<div class="main-wrapper">
  <!-- Workflow Sidebar -->
  <leftside>
    <div class="workflow-sidebar mb-3">
      <!-- <h6 class="mb-3"><strong>VM Actions</strong></h6> -->
      
      <div class="workflow-step active" onclick="showHelp('check')">
        <div class="icon">üîç</div>
        <div>Check Status</div>
      </div>

      <div class="workflow-step" onclick="showHelp('ssh')">
        <div class="icon">üîë</div>
        <div>SSH Access</div>
      </div>
  
      <div class="workflow-step" onclick="showHelp('monitor')">
        <div class="icon">üëÄ</div>
        <div>Monitor Resources</div>
      </div>

      <div class="workflow-step" onclick="showHelp('upload')">
        <div class="icon">üì§</div>
        <div>Upload Data</div>
      </div>

      <div class="workflow-step" onclick="showHelp('run')">
        <div class="icon">üöÄ</div>
        <div>Run Tasks</div>
      </div>
      
      <div class="workflow-step" onclick="showHelp('download')">
        <div class="icon">üì•</div>
        <div>Download Data</div>
      </div>

      <div class="workflow-step" onclick="showHelp('attach')">
        <div class="icon">üîó</div>
        <div>Attach Volume</div>
      </div>

      <div class="workflow-step" onclick="showHelp('detach')">
        <div class="icon">üîå</div>
        <div>Detach Volume</div>
      </div>

      <div class="workflow-step" onclick="showHelp('hibernate')">
        <div class="icon">‚è∏Ô∏è</div>
        <div>Hibernate VM</div>
      </div>
      
      <div class="workflow-step" onclick="showHelp('restore')">
        <div class="icon">‚ôªÔ∏è</div>
        <div>Restore VM</div>
      </div>

      <div class="workflow-step" onclick="showHelp('delete')">
        <div class="icon">üõë</div>
        <div>Delete VM</div>
      </div>
    
    </div>

  </leftside>


  <!-- Main Content -->
  <main class="main-content">
    <nav class="breadcrumbs" aria-label="breadcrumb">
      <ol>
        <li><a href="project_panel.html">üè† Home</a></li>
        <li class="active">Manage VMs</li>
      </ol>
    </nav>
    <!-- Main Card -->
    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-0">‚öôÔ∏è Manage VMs</h2>
          <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
            <span style="background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 1rem; display: inline-flex; align-items: center; gap: 6px;">
              <span style="font-size: 1.2rem;">üìÇ</span>
              <span id="projectNameDisplay">Loading...</span>
            </span>
            <small style="opacity: 0.75;">
              <code class="text-white" id="projectIdDisplay" style="font-size: 0.85rem;">Loading...</code>
            </small>
          </div>
        </div>
        <div class="d-flex gap-1">
          <!-- Documentation Links -->
          <div class="btn-group" role="group">
            <a href="documentation.html" class="btn btn-outline-light btn-sm" target="_blank" title="Complete User Guide">
              üìñ Documentation
            </a>
            <a href="cheatsheet.html" class="btn btn-outline-light btn-sm" target="_blank" title="Quick Reference">
              ‚ö° Cheat Sheet
            </a>
          </div>
          <button class="btn btn-light btn-sm" onclick="goBackToProjectPanel()">‚Üê Back</button>
        </div>
      </div>
    </div>
    <div class="card-body" style="background:white; padding: 5px;">
    <!-- VMs List Card -->
      <div class="card" style="margin-bottom: 5px; box-shadow: none; border: 1px solid #757de7;">
        <div class="card-header" style="background: #757de7; padding: 6px 6px; line-height: 1.1;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0">VMs (<span id="vmCount">0</span>)</h6>
            </div>
            <!-- Refresh Button -->
            <button id="refreshVmsButton"  class="btn btn-primary btn-sm" style="width: fit-content;" onclick="loadVms()">
                <span id="refreshBtn-text">üîÑ Refresh GPU VMs</span>
                <!-- <span id="refreshBtn-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span> -->
            </button>
          </div>
        </div>
        <div id="vmsList" style="max-height: 220px; min-height: 220px; overflow-y: auto; padding: 0;">
          <div class="text-center text-muted p-3">
            <p class="text-center mt-0 mb-0 fs-5">Loading VMs...</p>
            <div class="empty-state-icon" style="font-size: 2.5rem;">‚è≥</div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2 mb-0">
        <input type="hidden" id="vmName" value=""> 
        <p id="vmSelectedDisplay" class="alert alert-info text-center mb-0 p-2" style="display:none;">
            VM Selected: <strong><span id="selectedVmName"></span></strong>
        </p>
      </div>

      <div class="d-grid gap-2" id="vmActionButtons">
          <div class="btn-group d-flex gap-2">
              <button class="btn btn-primary" onclick="goToCreateVmPage()">‚ñ∂Ô∏è Create GPU VM</button>
              <button class="btn btn-warning" onclick="triggerLongAction('hibernate_vm')">‚è∏Ô∏è Hibernate GPU VM</button>
              <button class="btn btn-success" onclick="triggerLongAction('restore_vm')">‚ôªÔ∏è Restore GPU VM</button>
          </div>
          <button id="deleteVmButton" class="btn btn-danger" data-loading="Deleting VM...">üõë Delete GPU VM</button>
      </div>
    </div>

    <!-- Help Card (contextual) -->
    <div class="help-card mt-3" id="helpCard">
      <div id="helpContent">
        <strong>üîç Check VM Status</strong>
        <p class="mb-0 mt-2">Select a VM from the list below to view its current status and details.</p>
      </div>
    </div>

    <!-- Terminal container -->
    <div class="card mt-3" id="terminal-card" style="display: none;">
      <div class="card-header" style="background: #1e1e1e; color: white;">
        <div class="d-flex justify-content-between align-items-center">
          <strong>üñ•Ô∏è SSH Terminal - <span id="terminal-vm-name"></span></strong>
          <span id="terminal-vm-name"></span>
          <button class="btn btn-sm btn-outline-light" onclick="disconnectTerminal()">
            Disconnect
          </button>
          <button id="open-terminal-tab" class="btn btn-primary" style="display:none;">Open in New Tab</button>
        </div>
      </div>
      <div class="card-body p-0" style="background: #1e1e1e;">
        <div id="terminal" style="padding: 10px;"></div>
      </div>
    </div>

  </main>

  <rightside class="rightside">
     <div id="progress-panel" class="card mt-1" style="box-shadow: none; border: 1px solid #757de7;">
      <div class="card-header" style="background: #757de7; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">üß© Progress</h6>
        </div>
      </div>
      <div class="card-body" style="max-height: 160px; overflow-y: auto; padding: 0;">
          <div id="progress-content" class="alert alert-info" role="alert">
            Ready, waiting for user action.
          </div>
      </div>
    </div>

    <div id="status-message"></div>

    <div class="card mt-4" style="box-shadow: none; border: 1px solid #7e3baa;">
      <div class="card-header" style="background: #7e3baa; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üîç Details</h6>
          </div>
        </div>
      </div>

      <div class="card-body p-3" id="markdown-content-manage">
          <!-- Rendered markdown HTML goes here -->
      </div>
    </div>

    <div id="errorCard" class="card mt-4" style="display:none; box-shadow: none; border: 1px solid #e74a4a;">
      <div class="card-header" style="background: #e74a4a; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üö´ Errors</h6>
          </div>
        </div>
      </div>
      <div id="errorPanel" style="max-height: 100px; overflow-y: auto; padding: 0;">
        <div class="text-center text-muted p-3">
        </div>
      </div>
    </div>
  </rightside>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ‚ö†Ô∏è Are you sure you want to <strong>delete this GPU VM</strong>?<br>
        This action <strong>cannot be undone</strong>.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, delete it</button>
      </div>
    </div>
  </div>
</div>

<!-- Import SSH Key Modal -->
<div class="modal fade" id="importSshModal" tabindex="-1" aria-labelledby="importSshModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="importSshModalLabel">Import SSH Public Key</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <label for="sshPublicKey" class="form-label">Paste your SSH public key:</label>
        <textarea class="form-control" id="sshPublicKey" rows="4" placeholder="ssh-ed25519 AAAA..."></textarea>

        <div id="importSshFeedback" class="mt-2 text-danger" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="importSshBtn" class="btn btn-success">Import</button>
      </div>

    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
  <div id="sshToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="sshToastBody">
        SSH key imported successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
let currentUser = null;
let projectId = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('Handle VMs page loaded');
  // check if user is allowed
  currentUser = await requireAuth();
  if (!currentUser) {
    showMessage('You are not logged-in as an authenticated user', 'danger');
    return;
  }
  

  projectId = getProjectIdFromUrl();
  console.log('Project ID=', projectId);
  const projectName = await getProjectNameFromSupabase(projectId);
  console.log('Project Name:', projectName);
  // const projectName = localStorage.getItem('currentProjectName') || 'Untitled Project';
  
  document.getElementById('projectIdDisplay').textContent = projectId;
  document.getElementById('projectNameDisplay').textContent = projectName;

  if (!projectId) {
    showMessage('No project ID provided', 'danger');
    return;
  }

  // Check credits
  const hasCredits = checkCredits(projectId);
  
  if (!hasCredits) {
    console.log('üí∞‚ùå Project is out of credits - interface disabled');
  } else {
    console.log('‚úÖ Project has credits - interface enabled');
  }
  
  // Load VMs
  await loadVms();
});

// Help content for each action
const helpContent = {
  check: {
    title: 'üîç Check VM Status',
    content: `View current status, IP address, and resource usage of your VM.
    <p><strong>VM States:</strong></p>
    <table class="table table-sm table-bordered">
      <tr><td><span class="badge bg-secondary">PROVISIONING</span></td><td>Under creation...</td></tr>
      <tr><td><span class="badge bg-success">RUNNING</span></td><td>Running, billable</td></tr>
      <tr><td><span class="badge bg-warning">HIBERNATED</span></td><td>Stopped, storage only is billed, can be restored</td></tr>
      <tr><td><span class="badge bg-error">DELETED</span></td><td>Removed, can't be restored</td></tr>
    </table>
    <p class="mb-0">üí°<strong>Tip:</strong> Refresh status regularly to avoid idle GPU charges!</p>`
  },
  ssh: {
    title: 'üîëSSH Access to VM',
    content: `<p class="mb-0 mt-0"><strong>To access your VM, you first need to:</strong></p>
    <ol class="mb-0 mt-0">
      <li>Generate your own SSH key pair</li>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
          <code>ssh-keygen -t ed25519 -f ~/.ssh/my_ssh_key</code>
          <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('ssh-keygen -t ed25519 -f ~/.ssh/my_ssh_key')">Copy</button>
        </div>
        <p class="mt-2 mb-0">Then you need to restrict the priviledges of your private key as follows:</p>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
          <code>chmod 600 ~/.ssh/my_ssh_key</code>
          <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('chmod 600 ~/.ssh/my_ssh_key')">Copy</button>
        </div>
      <li>Import the public part of this key pair (aka your public key) to your VM:</li>
        <ol class="mb-0">
          <li>In this page, select your target VM</li>
          <li>In the "Details" panel, click on "‚ûïüîêImport my SSH public key" button</li>
          <li>Paste the content of your public key (my_ssh_key.pub) into the displayed field and click "import"</li>
          <li>‚ö†Ô∏èWarning: don't paste the content of your private key (my_ssh_key), this should never be disclosed</li>
        </ol>
      <li>Then you can access your VM through the <strong>SSH Command</strong> by pointing to the path of your private ssh key:</li>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
          <code>ssh -i ~/.ssh/my_ssh_key ubuntu@&lt;VM_IP&gt;</code>
          <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('ssh -i ~/.ssh/my_ssh_private_key ubuntu@&lt;VM_IP&gt;')">Copy</button>
        </div>
        <div>
          <p class="mt-2 mb-0"><strong>Alternative: Use MobaXterm (Windows):</strong></p>
            <ol class="mb-0">
              <li>Create new SSH session</li>
              <li>Enter VM IP address</li>
              <li>Specify username</li>
              <li>Use private key authentication (in "Advanced SSH settings")</li>
              <li>Save session for future use</li>
            </ol>
        </div>
    </ol>`
  },
  monitor: {
    title: 'üëÄMonitor VM Resources',
    content: `<p><strong>Essential Monitoring Commands:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code># GPU usage (live updates)<br>
      watch -n 2 nvidia-smi<br><br>
      # CPU and memory<br>
      htop<br><br>
      # Disk space<br>
      df -h<br>
      df -h /mnt/user_volume<br><br>
      # Disk I/O<br>
      iostat -x 2<br><br>
      # Find large files<br>
      du -ah /mnt/user_volume | sort -rh | head -20<br><br>
      # Check running processes<br>
      ps aux | grep python</code>
    </div>
    <p><strong>üí°Pro Tip:</strong> Use <code>tmux</code> to keep monitoring running in background!</p>`
  },
  upload: {
    title: 'üì§ Upload Data to VM',
    content: `Upload your code and data to the running VM:
      <p><strong>‚ö†Ô∏èImportant:</strong> Use a <strong>staging VM</strong> (cheap CPU) + volume for data uploads to save money!</p>
      <code style="background:#f8f9fa; padding:8px; display:block; border-radius:4px; margin:8px 0;">
        rsync -avz -P --checksum -e "ssh -i /path/to/ssh_private_key" ./dataset/ ubuntu@staging-vm-ip:/mnt/user_volume
        </code>
      <p class="mt-2"><strong>Cost-Saving Strategy:</strong></p>
      <ol class="mb-0">
        <li>Create a <code>Volume</code></li>
        <li>Attach it to a cheap <code>Staging VM</code> (CPU-only)</li>
        <li>Upload data to <code>Volume</code> on <code>Staging VM</code></li>
        <li>Unmount & Detach <code>Volume</code> from <code>Staging VM</code> then Attach & Mount it to <code>GPU VM</code></li>
        <li>Saves GPU hours during uploads!</li>
      </ol>`
  },
  run: {
    title: 'üöÄRun Your Tasks',
    content: `<p>SSH into your VM and run your workload:<br> <strong>‚ö†Ô∏èCritical:</strong> Always use <code>tmux</code> to keep jobs running after disconnect!</p>
      <code style="background:#f8f9fa; padding:8px; display:block; border-radius:4px; margin:8px 0;">
        ssh ubuntu@VM_IP<br>
        # Start tmux session<br>
        tmux new -s training<br><br>
        # Load modules<br>
        module load anaconda3/2024.02-1<br>
        module load ml_dl_gpu_base_all<br><br>
        # Run with output to volume<br>
        cd /your/project/path<br>
        python train.py \\<br>
        &nbsp;&nbsp;--data /mnt/user_volume/datasets/ \\<br>
        &nbsp;&nbsp;--output /mnt/user_volume/results/ \\<br>
        &nbsp;&nbsp;| tee /mnt/user_volume/logs/train.log<br><br>
        # Detach: Ctrl-B, then D<br>
        # Reattach: tmux attach -t training <br>
      </code>
          <p><strong>Monitoring:</strong></p>
      <ul class="mb-0">
        <li><code>watch -n 2 nvidia-smi</code> - GPU usage</li>
        <li><code>htop</code> - CPU/RAM usage</li>
        <li><code>df -h /mnt/user_volume</code> - Disk space</li>
      </ul>`
  },
  download: {
    title: 'üì• Step 7: Download Results',
    content: `<p><strong>From your laptop, run:</strong></p>
      <code style="background:#f8f9fa; padding:8px; display:block; border-radius:4px; margin:8px 0;">
        rsync -avz -P --checksum -e "ssh -i /path/to/ssh_private_key" ubuntu@VM_IP:/mnt/user_volume/results/ ./local_results/
      </code>`
  },
  attach: {
    title: 'üîóAttach Volume to VM',
    content: `<p><strong>Steps to attach a volume:</strong></p>
    <ol>
      <li>Select VM from list above</li>
      <li>In the <strong>Details</strong> section, click <strong>Attach Volume</strong></li>
      <li>Choose the target Volume from the displayed list</li>
      <li>Click on <strong>Attach Volume</strong></li>
      <li>Note the device path shown in UI</li>
    </ol>
    <p><strong>Mount the attached volume:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code>
      # SSH into your VM
      ssh -i ~/.ssh/my_ssh_private_key ubuntu@&lt;VM_IP&gt; <br>
      # Get device path from UI<br>
      DEVICE="/dev/disk/by-id/virtio-xxxxx"<br><br>
      # Verify the device exists <br>
      ls -l \$DEVICE <br>
      # Format to ext4 => ‚ö†Ô∏èOnly if the volume is attached for the first time <br>
      sudo mkfs.ext4 -F \${DEVICE} <br>
      # Create the folder that will be used as a mount point <br>
      sudo mkdir -p /mnt/user_volume<br>
      # Change the ownership of the folder <br>
      sudo chown ubuntu:ubuntu /mnt/user_volume/ <br>
      # Mount the volume to the created folder <br>
      sudo mount \${DEVICE} /mnt/user_volume<br><br>
      # Verify<br>
      df -h | grep user_volume</code>
    </div>
    <p class="mb-0"><strongüìíNote:</strong> Volume can only be attached to one VM at a time.</p>`
  },
  detach: {
    title: 'üîåDetach Volume from VM',
    content: `<p><strong>‚ö†Ô∏èCRITICAL: Always unmount before detaching!</strong></p>
    <p><strong>Safe detach procedure:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
      <code>
      # 0. SSH into your VM <br>
      ssh -i ~/.ssh/my_ssh_private_key ubuntu@&lt;VM_IP&gt; <br>
      # 1. Check what's using the mount<br>
      lsof /mnt/user_volume<br><br>
      # 2. Stop any processes using it<br>
      # (kill processes if needed)<br><br>
      # 3. Flush all writes<br>
      sync<br>
      # 4. Unmount safely<br>
      sudo umount /mnt/user_volume<br>
      # 5. Verify unmounted<br>
      df -h | grep user_volume  # Should show nothing</code>
    </div>
    <p><strong>Then in UI:</strong></p>
    <ol class="mb-0">
      <li>Go to VM details</li>
      <li>Find attached volumes section</li>
      <li>Click <strong>Detach</strong></li>
    </ol>
    <p class="mt-2 mb-0"><strong>‚ö†Ô∏èNever detach a mounted volume - data loss may occur!</strong></p>`
  },
  hibernate: {
    title: '‚è∏Ô∏è Hibernate VM',
    content: `Pause your VM to stop compute charges while preserving data:
      <strong>What happens:</strong><br>
      <ul>
        <li>VM stops running (compute charges stop)<li>
        <li>Data (in root disk) is preserved (storage charges continue)<li>
        <li>‚ö†Ô∏èCRITICAL: Data in Ephemeural memory won't be saved<li>
        <li>Can be restored later to same state</li>
        <li>Storage charges continue<li>
      </ul>
      <p><strong>Before hibernating:</strong></p>
      <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
        <code># Save any work in progress<br>
        # Stop running processes<br>
        # Unmount volumes<br>
        sync<br>
        sudo umount /mnt/user_volume</code>
      </div>
      <p><strong>To hibernate:</strong> Select VM and click <strong>‚è∏Ô∏èHibernate VM</strong> button.</p>
      <p class="mb-0"><strong>üí°Use Case:</strong> Taking a break for hours/days but will resume work later.</p>
      <p class="mb-0"><strong>üí°Tip:</strong>Going from Running to Hibernate typically takes 10-20 minutes.</p>`
    },
  restore: {
    title: '‚ôªÔ∏è Restore VM',
    content: `Resume a hibernated VM to continue your work.<br><br>
      <p><strong>What happens:</strong></p>
      <ul>
        <li>VM starts running again</li>
        <li>All data (from root disk) and state preserved</li>
        <li>Compute charges resume</li>
      </ul>
      <p><strong>After restoring:</strong></p>
      <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
        <code># SSH back into VM<br>
        ssh -i ~/.ssh/my_ssh_private_key ubuntu@&lt;VM_IP&gt;
        # Remount volumes if needed<br>
        DEVICE="/dev/disk/by-id/virtio-xxxxx"<br>
        sudo mount \${DEVICE} /mnt/user_volume<br>
        # Verify GPU is available<br>
        nvidia-smi<br>
        # Resume tmux sessions<br>
        tmux ls<br>
        tmux attach -t training</code>
      </div>
      <p><strong>To restore:</strong> Select VM and click <strong>‚ôªÔ∏èRestore VM</strong> button.</p>
      <p class="mb-0"><strong>üí°Tip:</strong> Restoration typically takes 10-20 minutes.</p>`
  },
  delete: {
    title: 'üõë Delete VM',
    content: `<span style="color: #dc3545;"><strong>‚ö†Ô∏èPERMANENT ACTION - CANNOT BE UNDONE!</strong></span><br><br>
      <p><strong>What will happen:</strong></p>
      <ul>
        <li>VM instance will be permanently deleted</li>
        <li>Root disk (OS and system files) will be deleted</li>
        <li>Ephemeral storage (all data!) will be deleted</li>
        <li>Attached volumes will NOT be deleted (but must be unmounted properly to avoid data loss)</li>
        <li>Volumes can then be attached to other VMs</li>
        <li>All charges related to this VM will stop immediately</li>
      <ul>
      <p><strong>‚ö†Ô∏èBEFORE DELETING:</strong></p>
      <ol>
        <li><strong>Download all important data!</strong></li>
        <li>Copy results from ephemeral storage to Volume (or Root Disk if it has enough space)</li>
        <li>Verify backups are complete</li>
        <li>Unmount volumes: <code>sync && sudo umount /mnt/user_volume</code></li>
      </ol>
      <small class="text-muted">Make sure to download any important data before deleting!</small>
      <p class="mt-2 mb-0"><strong>To delete:</strong> Select VM and click <strong>üõëDelete GPU VM</strong> button.</p>`
  }
};


function showHelp(action) {
  // ... update help content ...
  const help = helpContent[action];
  document.getElementById('helpContent').innerHTML = `
    <strong>${help.title}</strong>
    <p class="mb-0 mt-2">${help.content}</p>
  `;
  
  // Update active state
  document.querySelectorAll('.workflow-step').forEach(el => {
    el.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  // ‚úÖ Call separate function that doesn't need event
  // updateSidebarActive(action);
}

// New helper function
function updateSidebarActive(action) {
  const actionMap = {
    'check': 0,
    'upload': 1,
    'download': 2,
    'hibernate': 3,
    'restore': 4,
    'delete': 5
  };
  
  const steps = document.querySelectorAll('.workflow-step');
  steps.forEach(el => el.classList.remove('active'));
  
  const index = actionMap[action];
  if (index !== undefined && steps[index]) {
    steps[index].classList.add('active');
  }
}

function goBackToProjectPanel() {
  window.location.href = `project_panel.html?project_id=${encodeURIComponent(projectId)}`;
}

function goToCreateVmPage() {
  // Pass project ID to new page via URL parameter
  const creatVmUrl = `create_vm.html?project_id=${encodeURIComponent(projectId)}`;
  // Open in new tab
  window.open(creatVmUrl, '_blank');
}

document.getElementById("deleteVmButton").addEventListener("click", async () => {
  try {
    await deleteVm();
  } catch (err) {
    console.error('Unhandled error in deleteVm:', err);
    showMessage(`Unexpected error: ${err.message}`, 'danger');
  }
});

function selectVm(vmName) {
    // 1. Update the hidden input field (vmName)
    document.getElementById('vmName').value = vmName;

    // 2. Update the visual display
    document.getElementById('selectedVmName').textContent = vmName.replace(/_[^_]*$/, '');
    document.getElementById('vmSelectedDisplay').style.display = 'block';

    // 3. Highlight the selected item in the list
    const listItems = document.querySelectorAll('#vmsList .list-group-item');
    listItems.forEach(item => {
        item.classList.remove('selected');
    });

    // Find and highlight the specific item
    const selectedItem = document.querySelector(`[data-vm-name="${vmName}"]`);
    if (selectedItem) {
        selectedItem.classList.add('selected');
    }

    // 4. Enable the action buttons
    document.querySelectorAll('#vmActionButtons button').forEach(button => {
        button.disabled = false;
    });

    // Optional: Pre-fill status check
    CheckVmStatus(vmName); 
}

async function deleteVm() {
  // üßπ Reset any previous error display
  resetErrorCard();
  clearProgressPanel();

  const vmNameInput = document.getElementById('vmName').value.trim();
  if (!vmNameInput) {
    showMessage('Please enter a VM Name', 'warning');
    return;
  }

  const deleteModalEl = document.getElementById('confirmDeleteModal');
  const deleteModal = new bootstrap.Modal(deleteModalEl);

  // Replace button to avoid stacked listeners
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  confirmDeleteBtn.replaceWith(confirmDeleteBtn.cloneNode(true));
  const newConfirmDeleteBtn = document.getElementById('confirmDeleteBtn');

  // // Handle deletion
  // When user confirms deletion
  newConfirmDeleteBtn.addEventListener('click', async () => {
    const deleteVmButton = document.getElementById('deleteVmButton');
    const originalHTML = deleteVmButton.innerHTML;

    try {
      // Close modal
      deleteModal.hide();

      // Disable and show spinner on main button
      deleteVmButton.disabled = true;
      deleteVmButton.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Deleting GPU VM...
      `;

      // Perform delete action
      await triggerDeleteAction({ user_vm_name: vmNameInput });

      showMessage('GPU VM deleted successfully', 'success');
    } catch (err) {
      console.error('Error deleting VM:', err);
      showMessage('Failed to delete GPU VM', 'danger');
    } finally {
      // Restore button
      deleteVmButton.disabled = false;
      deleteVmButton.innerHTML = originalHTML;
    }
  });

  // Show the modal
  deleteModal.show();

  // AFTER (proper cleanup):
  const modal = bootstrap.Modal.getInstance(deleteModalEl);
  if (modal) {
    modal.hide();
  }
}

async function triggerDeleteAction(vmName) {

  const payload = { ...vmName, project_id: projectId };

  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/delete_vm`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);
    showProgress("VM deletion is starting", 'info', 'delete_vm');
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.message || 'Action failed');
    }
    
    showProgress("VM deletion started", 'info', 'delete_vm');
    // CheckVmStatus(vmName.user_vm_name);
    console.log('Response received:', data);
    
    if (data.success) {
      showProgress('VM deletion is over', 'info', 'delete_vm');
      // CheckVmStatus(vmName.user_vm_name);
      displayVmDetails(data);
      loadVms();
      return;
    } else {
        showProgress(`VM deletion failed: ${data.message || 'Unknown error'}`, 'danger', 'delete_vm');
        showError(JSON.stringify(data));
        throw new Error(data.message || 'Action failed');
    }
    
  } catch (error) {
    console.error('Error:', error);
    showProgress(`Error: ${error.message}`, 'danger', 'delete_vm');
    showError(error.message);
    throw error; // Re-throw so caller knows it failed
  }
}

async function triggerLongAction(action) {
  // üßπ Reset any previous error display
  resetErrorCard();
  clearProgressPanel();

  const vmNameInput = document.getElementById('vmName').value.trim();
  if (!vmNameInput) {
    console.log('No VM Name given');
    showMessage('Please enter a VM Name', 'warning');
    return;
  }

  // Identify the clicked button dynamically
  const button = event.target;
  const originalHTML = button.innerHTML;

  // Determine action label for spinner text
  const actionLabels = {
    hibernate_vm: 'Hibernating...',
    restore_vm: 'Restoring...'
  };
  const label = actionLabels[action] || 'Processing...';

  // Disable and show spinner
  button.disabled = true;
  button.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    ${label}
  `;

  const payload = { 
    vm_name: vmNameInput, 
    project_id: projectId 
  };

  let requestId = null;
  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/${action}`;
    
    console.log('Calling webhook:', webhookUrl, 'on inputs:', payload);
    showProgress('Handling VM...', 'info', action);
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.message || 'Action failed');
    }
    
    showProgress('‚úÖ Request accepted. Monitoring status...', 'success', action);
    // showDetails(JSON.stringify(data));
    displayVmDetails(data);
    
    if (!data.request_id) {
      // No real-time tracking available
      button.disabled = false;
      button.innerHTML = originalHTML;
      return data;
    }
    
    requestId = data.request_id;

    // Start subscription BEFORE creating the promise
    await subscribeToStatusUpdates(requestId, action);

    // Add initial polling to catch current state
    const initialStatus = await pollCurrentStatus(requestId);
    if (initialStatus) {
      handleRealtimeUpdate(initialStatus, action);
    }

    // Create promise and subscription together
    const finalData = await new Promise((resolve, reject) => {
      // Store resolver with timeout
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error(`Timed out waiting for ${action} to complete.`));
      }, 1800000); // 30 minutes

      actionResolvers[requestId] = { 
        resolve: (data) => {
          cleanup();
          // ‚úÖ Action finished successfully ‚Üí re-enable button
          button.disabled = false;
          button.innerHTML = originalHTML;
          resolve(data);
        },
        reject: (error) => {
          cleanup();
          // ‚ùå Action failed ‚Üí re-enable anyway
          button.disabled = false;
          button.innerHTML = originalHTML;
          reject(error);
        },
        timeout
      };
      
      // Cleanup helper
      function cleanup() {
        if (actionResolvers[requestId]) {
          clearTimeout(actionResolvers[requestId].timeout);
          delete actionResolvers[requestId];
        }
        if (activeChannel) {
          activeChannel.unsubscribe();
          activeChannel = null;
        }
      }
      
      // Start subscription
      // subscribeToStatusUpdates(requestId, action).catch(reject);
    });
    displayVmDetails(data);
    loadVms();
    return finalData;
    
  } catch (error) {
    // Cleanup on any error
    if (requestId && actionResolvers[requestId]) {
      clearTimeout(actionResolvers[requestId].timeout);
      delete actionResolvers[requestId];
    }
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    }
    
    showProgress(`‚ùå Error: ${error.message}`, 'danger');
    showError(error.message);
    // addToHistory(action, error.message, 'danger');
    // Ensure button resets even on early error
    button.disabled = false;
    button.innerHTML = originalHTML;
    throw error; // Re-throw so caller knows it failed
  } finally {
    CheckVmStatus(vmNameInput);
  }
}

function displayVmsList(responseData) {
  const data = Array.isArray(responseData) ? responseData[0] : responseData;
  const vms = data.vms || [];
  
  document.getElementById('vmCount').textContent = vms.length;
  
  const vmsListDiv = document.getElementById('vmsList');
  
  if (vms.length === 0) {
    vmsListDiv.innerHTML = '<div class="text-muted p-3">No VMs found</div>';
    // Disable buttons if no VMs exist
    document.querySelectorAll('#vmActionButtons button').forEach(button => {
      button.disabled = true;
    });
    document.getElementById('vmSelectedDisplay').style.display = 'none';
    return;
  }
  
  vmsListDiv.innerHTML = `
    <div class="list-group list-group-flush">
      ${vms.map(vm => `
        <div class="list-group-item list-group-item-action" 
              onclick="selectVm('${escapeHtml(vm.vm_name)}')"
              data-vm-name="${escapeHtml(vm.vm_name)}"
              style="cursor: pointer;">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${escapeHtml(vm.vm_name.replace(/_[^_]*$/, ''))}</strong>
              <br>
              <small class="text-muted">
                ${escapeHtml(vm.vm_ip) || 'N/A'} ‚Ä¢ $${(vm.total_cost || 0).toFixed(2)}
              </small>
            </div>
            <span class="vm-status ${escapeHtml(vm.status)}">${escapeHtml(vm.status.toUpperCase())}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  // Ensure buttons are disabled until a selection is made (unless a selection was preserved)
  document.querySelectorAll('#vmActionButtons button').forEach(button => {
      button.disabled = true;
  });
  document.getElementById('vmSelectedDisplay').style.display = 'none';
}

async function loadVms() {
  // üßπ Reset any previous error display
  resetErrorCard();
  clearProgressPanel();

  const refreshBtn = document.getElementById('refreshVmsButton');
  const refreshText = document.getElementById('refreshBtn-text');

  // Disable button immediately and show spinner
  refreshBtn.disabled = true;
  const originalHTML = refreshBtn.innerHTML;

  refreshBtn.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    Refreshing GPU VMs...
  `;

  const payload = { project_id: projectId };

  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/list_vms`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);
    // showProgress("VMs listing", 'info', 'list_vms');
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    console.log('Response received:', data);
    
    if (data.success) {
      // showMessage(`üîÑ VM list updated`, 'success');
      //list the VMs
      displayVmsList(data);
    } else {
      document.getElementById('vmsList').innerHTML = '<div class="text-secondary p-3">No VMs to display, go to "Create VM" page: <button class="btn btn-primary btn-sm" onclick="goToCreateVmPage()">‚ñ∂Ô∏è Create VM</button></div>';
    }
    
  } catch (error) {
    console.error('Error:', error);
    showProgress(`Error: ${error.message}`, 'danger', 'list_vms');
    showError(error.message);
  } finally {
    // 2Ô∏è‚É£ Re-enable button and restore original content
    refreshBtn.disabled = false;
    refreshBtn.innerHTML = originalHTML;
  }
}

</script>

<script src="utils.js"></script>

<!-- Attach Volume Modal -->
<div class="modal fade" id="attachVolumeModal" tabindex="-1" aria-labelledby="attachVolumeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="attachVolumeModalLabel">üìé Attach Volume to VM</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Attaching volume to: <strong><span id="modalVmName"></span></strong></p>
        
        <label for="volumeSelect" class="form-label"><strong>Select Volume:</strong></label>
        <select id="volumeSelect" class="form-select" size="5">
          <option value="">Loading volumes...</option>
        </select>
        
        <div id="volumeInfo" class="mt-3 p-2" style="background: #f8f9fa; border-radius: 5px; display: none;">
          <small><strong>Selected Volume:</strong></small><br>
          <small><span id="volumeDetails"></span></small>
        </div>
        
        <div id="attachVolumeError" class="alert alert-warning mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAttachBtn" onclick="confirmAttachVolume()">
          Attach Volume
        </button>
      </div>
    </div>
  </div>
</div>
</body>

</html>