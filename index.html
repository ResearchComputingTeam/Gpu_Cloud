<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPU Cloud Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { padding: 20px; background-color: #f8f9fa; }
.container { max-width: 600px; margin-top: 50px; }
button { margin: 5px; }
.card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
#status-message { margin-top: 20px; }

#feedback-panel .card {
  border-width: 2px;
  margin-top: 20px;
  animation: slideDown 0.3s ease-out;
}

#feedback-panel .card-header {
  font-size: 1.1rem;
  padding: 12px 16px;
}

#feedback-panel .card-body {
  padding: 20px;
  background-color: #bea9f1;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-body">
      <h2 class="card-title">GPU Cloud Control</h2>
      <div class="mb-3">
        <label for="request_id" class="form-label">Request ID</label>
        <input type="text" id="request_id" class="form-control" placeholder="Enter your request ID">
      </div>
      <div class="d-grid gap-2">
        <!-- <button class="btn btn-primary" onclick="updateStatus('simulation_running')">‚ñ∂Ô∏è Run Simulation</button>
        <button class="btn btn-warning" onclick="updateStatus('simulation_paused')">‚è∏Ô∏è Pause Simulation</button>
        <button class="btn btn-success" onclick="updateStatus('simulation_running')">üîÅ Resume Simulation</button>
        <button class="btn btn-danger" onclick="updateStatus('simulation_complete')">üõë Stop Simulation</button>
        <button class="btn btn-info" onclick="updateStatus('finalized')">üí∞ Finalize & Show Credits</button> -->
        <button class="btn btn-primary" onclick="trigger('run_simulation')">‚ñ∂Ô∏è Run Simulation</button>
        <button class="btn btn-warning" onclick="trigger('pause_simulation')">‚è∏Ô∏è Pause Simulation</button>
        <button class="btn btn-success" onclick="trigger('resume_simulation')">üîÅ Resume Simulation</button>
        <button class="btn btn-danger" onclick="trigger('stop_simulation')">üõë Stop Simulation</button>
        <button class="btn btn-secondary" onclick="trigger('get_workflow_status')">üîç Check Status</button>
        <button class="btn btn-info" onclick="trigger('show_credits')">üí∞ Show Credit Usage</button>
      </div>
      <div id="status-message"></div>
      <div id="feedback-panel" class="mt-3"></div>
      <div class="mt-4">
        <h5>History</h5>
        <div id="responseHistoryList" class="list-group" style="max-height:150px; overflow-y:auto;">
          <!-- History items will be injected here -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize Supabase client
// const supabaseUrl = 'https://dgttklfdlwaxvxjubcxx.supabase.co';
// const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRndHRrbGZkbHdheHZ4anViY3h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTkzNTAsImV4cCI6MjA3NDI5NTM1MH0.ZggUBEE_GN0e_-b4TQL8yaXfe5ckoD6AglORC7NdYwQ';
// const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);


function showMessage(message, type = 'info') {
  const statusDiv = document.getElementById('status-message');
  statusDiv.innerHTML = `<div class="alert alert-${type} mt-3" role="alert">${message}</div>`;
  setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
}

function clearMessage() {
  const statusDiv = document.getElementById('status-message');
  statusDiv.innerHTML = '';
}

let responseHistory = [];

function addToHistory(action, message, type) {
  const timestamp = new Date().toLocaleString();
  
  // Extract clean summary for history
  let summary = 'Action completed';
  try {
    let data = typeof message === 'string' ? JSON.parse(message) : message;
    if (data.message) {
      summary = data.message;
    } else if (data.status) {
      summary = `Status: ${data.status}`;
    }
  } catch (e) {
    summary = typeof message === 'string' ? message : 'Action completed';
  }
  
  responseHistory.unshift({ 
    action: getActionLabel(action), 
    message: summary, 
    fullData: message, // Store full data for popover
    type, 
    timestamp 
  });
  
  if (responseHistory.length > 20) {
    responseHistory = responseHistory.slice(0, 20);
  }
  
  renderHistory();
}

function renderHistory() {
  const historyDiv = document.getElementById('responseHistoryList');
  
  if (responseHistory.length === 0) {
    historyDiv.innerHTML = '<div class="text-muted p-3 text-center">No requests yet</div>';
    return;
  }
  
  historyDiv.innerHTML = responseHistory.map((item, idx) => {
    // Get icon based on type
    const icon = item.type === 'success' || item.type === 'primary' ? '‚úÖ' : 
                 item.type === 'danger' ? '‚ùå' : 
                 item.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    
    // Truncate message if too long
    let displayMsg = item.message;
    if (displayMsg.length > 60) {
      displayMsg = displayMsg.substring(0, 60) + '...';
    }
    
    // Format full data for popover
    let popoverContent = '';
    try {
      let data = typeof item.fullData === 'string' ? JSON.parse(item.fullData) : item.fullData;
      popoverContent = formatResponseDataForPopover(data);
    } catch (e) {
      popoverContent = escapeHtml(String(item.fullData));
    }
    
    return `
      <button type="button"
        class="list-group-item list-group-item-action list-group-item-${item.type} d-flex justify-content-between align-items-center"
        data-bs-toggle="popover"
        data-bs-trigger="hover focus"
        data-bs-placement="right"
        data-bs-html="true"
        data-bs-title="${icon} ${item.action}"
        data-bs-content="${popoverContent}">
        <div>
          <div><strong>${item.action}</strong></div>
          <small class="text-muted">${displayMsg}</small>
        </div>
        <span class="badge bg-secondary">${item.timestamp}</span>
      </button>
    `;
  }).join('');

  // Dispose old popovers
  const oldPopovers = document.querySelectorAll('[data-bs-toggle="popover"]');
  oldPopovers.forEach(el => {
    const instance = bootstrap.Popover.getInstance(el);
    if (instance) instance.dispose();
  });

  // Initialize new popovers
  const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
  popoverTriggerList.forEach(function (popoverTriggerEl) {
    new bootstrap.Popover(popoverTriggerEl, {
      html: true,
      sanitize: false
    });
  });
}

function formatResponseDataForPopover(data) {
  let html = '<div style="max-width:300px;">';
  
  if (data.message) {
    html += `<p class="mb-2"><strong>Message:</strong><br>${escapeHtml(data.message)}</p>`;
  }
  
  if (data.status) {
    html += `<p class="mb-2"><strong>Status:</strong> ${escapeHtml(data.status)}</p>`;
  }
  
  if (data.vm_id) {
    html += `<p class="mb-2"><strong>VM ID:</strong> <code>${escapeHtml(data.vm_id)}</code></p>`;
  }
  
  if (data.credits_used) {
    html += `<p class="mb-2"><strong>Credits:</strong> $${data.credits_used}</p>`;
  }
  
  // If nothing matched, show the raw message
  if (html === '<div style="max-width:300px;">') {
    html += `<pre style="font-size:0.85em; margin:0;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
  }
  
  html += '</div>';
  
  return html.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

function showFeedbackPanel(message, type = 'info', action = '') {
  const panel = document.getElementById('feedback-panel');
  
  let displayHTML = '';
  
  try {
    // Try to parse JSON response
    let data = typeof message === 'string' ? JSON.parse(message) : message;
    
    // Format based on the response structure
    displayHTML = formatResponseData(data, action);
    
  } catch (e) {
    // If not JSON, just display the text
    displayHTML = `<p class="mb-0">${escapeHtml(message)}</p>`;
  }
  

  panel.innerHTML = `
    <div class="card" style="border: 2px solid #6610f2;">
      <div class="card-header" style="background-color: #6610f2; color: white;">
        <strong>${getActionLabel(action)}</strong>
      </div>
      <div class="card-body">
        ${displayHTML}
      </div>
    </div>
  `;
  
  if (action) addToHistory(action, message, type);
}

function getActionLabel(action) {
  const labels = {
    'run_simulation': '‚ñ∂Ô∏è Starting Simulation',
    'pause_simulation': '‚è∏Ô∏è Pausing Simulation',
    'resume_simulation': 'üîÅ Resuming Simulation',
    'stop_simulation': 'üõë Stopping Simulation',
    'get_workflow_status': 'üîç Checking Status',
    'show_credits': 'üí∞ Credit Information'
  };
  return labels[action] || action;
}

function formatResponseData(data, action) {
  let html = '';
  
  // Main message (if exists)
  if (data.message) {
  html += `<div class="alert mb-3" style="background-color: #e2d9f3; border-left: 4px solid #6610f2; color: #6610f2;">
    <i class="bi bi-info-circle"></i> ${escapeHtml(data.message)}
  </div>`;
}
  
  // Build details list
  const details = [];
  
  // Common fields
  if (data.status) {
    details.push({
      label: 'Status',
      value: `<span class="badge bg-primary">${escapeHtml(data.status)}</span>`
    });
  }
  
  if (data.request_id) {
    details.push({
      label: 'Request ID',
      value: `<code>${escapeHtml(data.request_id)}</code>`
    });
  }
  
  if (data.vm_id) {
    details.push({
      label: 'VM ID',
      value: `<code>${escapeHtml(data.vm_id)}</code>`
    });
  }
  
  if (data.vm_ip) {
    details.push({
      label: 'VM IP Address',
      value: `<code>${escapeHtml(data.vm_ip)}</code> 
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${data.vm_ip}')">
                üìã Copy
              </button>`
    });
  }
  
  if (data.ssh_command) {
    details.push({
      label: 'SSH Command',
      value: `<code>${escapeHtml(data.ssh_command)}</code>
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${data.ssh_command}')">
                üìã Copy
              </button>`
    });
  }
  
  if (data.credits_used !== undefined) {
    details.push({
      label: 'Credits Used',
      value: `<strong>$${parseFloat(data.credits_used).toFixed(2)}</strong>`
    });
  }
  
  if (data.credits_remaining !== undefined) {
    details.push({
      label: 'Credits Remaining',
      value: `<strong>$${parseFloat(data.credits_remaining).toFixed(2)}</strong>`
    });
  }
  
  if (data.estimated_time) {
    details.push({
      label: 'Estimated Time',
      value: `<span class="text-muted">${escapeHtml(data.estimated_time)}</span>`
    });
  }
  
  if (data.runtime) {
    details.push({
      label: 'Runtime',
      value: `<span class="text-muted">${escapeHtml(data.runtime)}</span>`
    });
  }
  
  if (data.gpu_type) {
    details.push({
      label: 'GPU Type',
      value: `<span class="badge bg-success">${escapeHtml(data.gpu_type)}</span>`
    });
  }
  
  if (data.timestamp) {
    details.push({
      label: 'Timestamp',
      value: `<small class="text-muted">${escapeHtml(data.timestamp)}</small>`
    });
  }

  if (data.workflow_status) {
  details.push({
    label: 'Workflow Status',
    value: `<span class="badge bg-info">${escapeHtml(data.workflow_status)}</span>`
  });
  }
  
  // Render details as a table
  if (details.length > 0) {
    html += '<table class="table table-sm table-borderless mb-0">';
    details.forEach(detail => {
      html += `
        <tr>
          <td class="text-muted" style="width: 40%;">${detail.label}:</td>
          <td>${detail.value}</td>
        </tr>
      `;
    });
    html += '</table>';
  }
  
  // If no specific fields matched, show a generic success message
  if (!html) {
    html = '<p class="text-success mb-0">‚úÖ Action completed successfully</p>';
  }
  
  return html;
}

// Helper function to escape HTML
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// Helper function to copy to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showMessage('‚úÖ Copied to clipboard!', 'success');
  }).catch(err => {
    showMessage('‚ùå Failed to copy', 'danger');
  });
}


function trigger(action) {
  clearMessage();
  const requestId = document.getElementById('request_id').value.trim();
  if (!requestId) {
    showMessage('Please enter a Request ID', 'warning');
    return;
  }

  const webhookUrl = `https://nonserially-unpent-jin.ngrok-free.dev/webhook/${action}?request_id=${encodeURIComponent(requestId)}`;
  
  console.log('Attempting to process Request ID:', requestId);

  try {
    fetch(webhookUrl, { method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: requestId })
    })
      .then(r => r.text())
      .then(msg => showFeedbackPanel(msg, 'primary', action))
      .catch(err => showFeedbackPanel('Error: ' + err, 'danger', action));

  } catch (err) {
    // console.error('Unexpected error:', err);
    showMessage(`Error: ${err.message}`, 'danger');
  }
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
