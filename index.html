<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPU Cloud Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body { padding: 20px; background-color: #f8f9fa; }
.container { max-width: 600px; margin-top: 50px; }
button { margin: 5px; }
.card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
#status-message { margin-top: 20px; }

#progress-panel .alert {
  background-color: #d1ecf1 !important; /* Bootstrap's light blue */
  color: #0c5460 !important;            /* Bootstrap's blue text */
  border-left: 4px solid #0c5460;
}

#progress-panel table,
#progress-panel td,
#progress-panel th {
  background-color: transparent !important;
}
#feedback-panel .card {
  border-width: 2px;
  margin-top: 20px;
  animation: slideDown 0.3s ease-out;
}

#feedback-panel .card-header {
  font-size: 1.1rem;
  padding: 12px 16px;
}

#feedback-panel .card-body {
  padding: 20px;
  background-color: #bea9f1;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#markdown-panel .card-body {
  background: #f8f9fa;
  font-size: 1rem;
  padding: 1rem;
}

#markdown-panel .card-header {
  background-color: #6f42c1;   /* Bootstrap purple */
  color: #fff;                 /* White text */
  /* border-bottom: 2px solid #4b286d; Darker purple border */
  border: 2px solid #6f42c1;
}

#markdown-panel {
  border: 2px solid #6f42c1;   /* Match header color or choose another */
}

</style>
</head>
<body>

<div class="container mt-4" style="max-width: 400px;">



</div>


<div class="container">
  <div class="card">
    <div class="card-body">
      <h2 class="card-title">GPU Cloud Control</h2>
      <div class="mb-3">
        <label for="request_id" class="form-label">Request ID</label>
        <input type="text" id="request_id" class="form-control" placeholder="Enter your request ID">
      </div>
      <div class="d-grid gap-2">
        <!-- <button class="btn btn-primary" onclick="updateStatus('simulation_running')">‚ñ∂Ô∏è Run Simulation</button>
        <button class="btn btn-warning" onclick="updateStatus('simulation_paused')">‚è∏Ô∏è Pause Simulation</button>
        <button class="btn btn-success" onclick="updateStatus('simulation_running')">üîÅ Resume Simulation</button>
        <button class="btn btn-danger" onclick="updateStatus('simulation_complete')">üõë Stop Simulation</button>
        <button class="btn btn-info" onclick="updateStatus('finalized')">üí∞ Finalize & Show Credits</button> -->
        <div class="d-flex justify-content-between">
          <button class="btn btn-primary" onclick="trigger('run_simulation_simple')">‚ñ∂Ô∏è Run / Resume Simulation</button>
          <button class="btn btn-warning" onclick="trigger('pause_simulation')">‚è∏Ô∏è Pause Simulation</button>
          <button class="btn btn-danger" onclick="trigger('stop_simulation')">üõë Stop Simulation</button>
        </div>
          <!-- Feedback Panel -->
        <!-- <div class="alert alert-info" role="alert">
          Provisionning in progress. Please wait...
        </div> -->

        <!-- Progress Bar -->
        <!-- <div class="progress mb-3">
          <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
              role="progressbar" style="width: 60%;" aria-valuenow="60"
              aria-valuemin="0" aria-valuemax="100"></div>
        </div> -->
        <!-- <button class="btn btn-success" onclick="trigger('resume_simulation')">üîÅ Place Holder</button> -->
        <button class="btn btn-secondary" onclick="trigger('check_status')">üîç Check Status</button>
        <button class="btn btn-info" onclick="trigger('show_credits')">üí∞ Show Credit Usage</button>
      </div>

      <!-- <div id="feedback-panel" class="mt-3">
        Ready, Waiting for user action...
      </div> -->

      <div id="progress-panel" class="mt-3">
        <h5>Progress Panel</h5>
        <div id="progress-content" class="alert alert-info" role="alert">
          Ready, waiting for user action.
        </div>
      </div>

      <div id="loading-spinner" class="text-center my-3" style="display:none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Progress Panel (always visible) -->
      <!-- <div id="progress-panel" class="mt-3">
        <h5>Progress Panel</h5>
        <div id="progress-content" class="alert alert-secondary" role="alert">
          No progress yet.
        </div>
      </div> -->

      <div class="card mt-3" id="markdown-panel" style="max-height: 400px; overflow-y: auto;">
        <div class="card-header text-white">
          <strong>Details</strong>
        </div>
        <div class="card-body" id="markdown-content">
          <!-- Rendered markdown HTML goes here -->
        </div>
      </div>

      <div class="mt-4">
        <h6>History</h6>
        <div id="responseHistoryList" class="list-group" style="max-height:100px; overflow-y:auto;">
          <!-- History items will be injected here -->
        </div>
      </div>

      <div id="status-message"></div>
    </div>
  </div>
</div>

<script>
// Initialize Supabase client
const supabaseUrl = 'https://dgttklfdlwaxvxjubcxx.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRndHRrbGZkbHdheHZ4anViY3h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MTkzNTAsImV4cCI6MjA3NDI5NTM1MH0.ZggUBEE_GN0e_-b4TQL8yaXfe5ckoD6AglORC7NdYwQ';
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);


function showMessage(message, type = 'info') {
  const statusDiv = document.getElementById('status-message');
  statusDiv.innerHTML = `<div class="alert alert-${type} mt-3" role="alert">${message}</div>`;
  setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
}

function clearMessage() {
  const progressDiv = document.getElementById('progress-content');
  progressDiv.innerHTML = '';
  const detailsDiv = document.getElementById('markdown-content');
  detailsDiv.innerHTML = '';
}

let responseHistory = [];

function addToHistory(action, message, type) {
  const timestamp = new Date().toLocaleString();
  
  // Extract clean summary for history
  let summary = 'Action completed';
  try {
    let data = typeof message === 'string' ? JSON.parse(message) : message;
    if (data.message) {
      summary = data.message;
    } else if (data.status) {
      summary = `Status: ${data.status}`;
    }
  } catch (e) {
    summary = typeof message === 'string' ? message : 'Action completed';
  }
  
  responseHistory.unshift({ 
    action: getActionLabel(action), 
    message: summary, 
    fullData: message, // Store full data
    type, 
    timestamp 
  });
  
  if (responseHistory.length > 20) {
    responseHistory = responseHistory.slice(0, 20);
  }
  
  renderHistory();
}

function renderHistory() {
  const historyDiv = document.getElementById('responseHistoryList');
  
  if (responseHistory.length === 0) {
    historyDiv.innerHTML = '<div class="text-muted p-3 text-center">No requests yet</div>';
    return;
  }
  
  historyDiv.innerHTML = responseHistory.map((item, idx) => {
    // Get icon based on type
    const icon = item.type === 'success' || item.type === 'primary' ? '‚úÖ' : 
                 item.type === 'danger' ? '‚ùå' : 
                 item.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    
    // Truncate message if too long
    let displayMsg = item.message;
    if (displayMsg.length > 60) {
      displayMsg = displayMsg.substring(0, 60) + '...';
    }
    
    return `
    <div class="list-group-item list-group-item-${item.type} d-flex justify-content-between align-items-center">
      <div>
        <div><strong>${icon} ${item.action}</strong></div>
        <small class="text-muted">${displayMsg}</small>
      </div>
      <span class="badge bg-secondary">${item.timestamp}</span>
    </div>
  `;
  }).join('');
}

function showProgress(message, type = 'info', action = '') {
  const progressDiv = document.getElementById('progress-content');
  progressDiv.className = `alert alert-${type}`;
  progressDiv.innerHTML = message;
  if (action) addToHistory(action, message, type);
}

function showDetails(msg) {
  const markdownDiv = document.getElementById('markdown-content');
  let markdownText = '';

  try {
    // Try to parse as JSON and extract 'message' field
    const data = typeof msg === 'string' ? JSON.parse(msg) : msg;
    if (data.message) {
      markdownText = data.message;
    } else {
      // If no 'message' field, fallback to stringified object
      markdownText = JSON.stringify(data, null, 2);
    }
  } catch (e) {
    // If not JSON, treat msg as markdown/text
    markdownText = msg;
  }

  // Parse markdown and display
  markdownDiv.innerHTML = marked.parse(markdownText);
}

function getActionLabel(action) {
  const labels = {
    'run_simulation': '‚ñ∂Ô∏è Starting Simulation',
    'pause_simulation': '‚è∏Ô∏è Pausing Simulation',
    'resume_simulation': 'üîÅ Resuming Simulation',
    'stop_simulation': 'üõë Stopping Simulation',
    'get_workflow_status': 'üîç Checking Status',
    'show_credits': 'üí∞ Credit Information'
  };
  return labels[action] || action;
}

function formatResponseData(data, action) {
  let html = '';
  
  // Main message (if exists)
  if (data.message) {
  // Parse markdown to HTML
  const htmlContent = marked.parse(data.message);
  html += `<div class="alert mb-3" style="background-color: #d1ecf1; border-left: 4px solid #0c5460; color: #0c5460;">
    ${htmlContent}
  </div>`;
  }
  
  // Build details list
  const details = [];
  
  // Common fields
  if (data.status) {
    details.push({
      label: 'Status',
      value: `<span class="badge bg-primary">${escapeHtml(data.status)}</span>`
    });
  }
  
  if (data.request_id) {
    details.push({
      label: 'Request ID',
      value: `<code>${escapeHtml(data.request_id)}</code>`
    });
  }
  
  if (data.vm_id) {
    details.push({
      label: 'VM ID',
      value: `<code>${escapeHtml(data.vm_id)}</code>`
    });
  }
  
  if (data.vm_ip) {
    details.push({
      label: 'VM IP Address',
      value: `<code>${escapeHtml(data.vm_ip)}</code> 
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${data.vm_ip}')">
                üìã Copy
              </button>`
    });
  }
  
  if (data.ssh_command) {
    details.push({
      label: 'SSH Command',
      value: `<code>${escapeHtml(data.ssh_command)}</code>
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('${data.ssh_command}')">
                üìã Copy
              </button>`
    });
  }
  
  if (data.credits_used !== undefined) {
    details.push({
      label: 'Credits Used',
      value: `<strong>$${parseFloat(data.credits_used).toFixed(2)}</strong>`
    });
  }
  
  if (data.credits_remaining !== undefined) {
    details.push({
      label: 'Credits Remaining',
      value: `<strong>$${parseFloat(data.credits_remaining).toFixed(2)}</strong>`
    });
  }
  
  if (data.estimated_time) {
    details.push({
      label: 'Estimated Time',
      value: `<span class="text-muted">${escapeHtml(data.estimated_time)}</span>`
    });
  }
  
  if (data.runtime) {
    details.push({
      label: 'Runtime',
      value: `<span class="text-muted">${escapeHtml(data.runtime)}</span>`
    });
  }
  
  if (data.gpu_type) {
    details.push({
      label: 'GPU Type',
      value: `<span class="badge bg-success">${escapeHtml(data.gpu_type)}</span>`
    });
  }
  
  if (data.timestamp) {
    details.push({
      label: 'Timestamp',
      value: `<small class="text-muted">${escapeHtml(data.timestamp)}</small>`
    });
  }

  if (data.request_status) {
  details.push({
    label: 'Workflow Status',
    value: `<span class="badge bg-info">${escapeHtml(data.request_status)}</span>`
  });
  }
  
  // Render details as a table
  if (details.length > 0) {
    html += '<table class="table table-sm table-borderless mb-0" style="background-color: transparent;">';
    details.forEach(detail => {
      html += `
        <tr>
          <td class="text-muted" style="width: 40%;">${detail.label}:</td>
          <td>${detail.value}</td>
        </tr>
      `;
    });
    html += '</table>';
  }
  
  // If no specific fields matched, show a generic success message
  if (!html) {
    html = '<p class="text-success mb-0">‚úÖ Action completed successfully</p>';
  }
  
  return html;
}

// Helper function to escape HTML
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// HELPERS
// Helper function to copy to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showMessage('‚úÖ Copied to clipboard!', 'success');
  }).catch(err => {
    showMessage('‚ùå Failed to copy', 'danger');
  });
}

function showSpinner() {
  document.getElementById('loading-spinner').style.display = 'block';
}

function hideSpinner() {
  document.getElementById('loading-spinner').style.display = 'none';
}

let webhook_response = null;

async function trigger(action) {
  clearMessage();
  showSpinner(); // Show spinner when request starts
  const requestId = document.getElementById('request_id').value.trim();
  if (!requestId) {
    showProgress('Please enter a Request ID', 'warning');
    hideSpinner();
    return;
  }

  //Initial check of Request ID
  const initialRequestIDCheck = `https://nonserially-unpent-jin.ngrok-free.dev/webhook/check_id?request_id=${encodeURIComponent(requestId)}`;
  console.log('Attempting to process Request ID:', requestId);
  try {
    const response = await fetch(initialRequestIDCheck, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: requestId })
    });
    const check_msg = await response.text();
    try {
      data = JSON.parse(check_msg);
    } catch (e) {
      console.error('Response is not valid JSON:', e);
      return;
    }
    if (data.success === true) {
      console.log('Request ID is valid');
      //proceed with the rest of the code
    } else {
      hideSpinner();
      console.log('Request ID is not valid');
      // showProgress(`Error: ${err.message}`, 'danger');
      showProgress(`Error: Request ID is not valid`, 'danger');
      return;
    }
  } catch (err) {
    console.error('Check status error:', err);
    showProgress(`Error: ${err.message}`, 'danger');
    return;
  }

  // üî• Start listening for real-time updates
  if (action === 'run_simulation_simple' || action === 'pause_simulation' || action === 'stop_simulation') {
    subscribeToStatusUpdates(requestId, action);
  }

  const webhookUrl = `https://nonserially-unpent-jin.ngrok-free.dev/webhook/${action}?request_id=${encodeURIComponent(requestId)}`;
  console.log('Attempting to process Request ID:', requestId);

  if (action === 'check_status') {
    try {
      const response = await fetch(webhookUrl, { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request_id: requestId })
      });
      const check_msg = await response.text();
      const data = JSON.parse(check_msg);
      const check_message = `STATUS = ${data.request_status} started by ${data.user_name} at ${new Date(data.first_time_start).toLocaleString('en-US')}`;

      showProgress(`STATUS = ${data.request_status}`, 'info');
      const showProgressDiv = document.getElementById('markdown-content');
      showProgressDiv.innerHTML = check_message;
      addToHistory(action, check_message, 'info');
      hideSpinner();
    } catch (err) {
      console.error('Check status error:', err);
      showProgress(`Error: ${err.message}`, 'danger');
    }
  } else { //Trigger is not Check Status
    // Fire and forget - don't await this
    fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: requestId })
    })
      .then(response => response.text())
      .then(msg => {
        console.log('Webhook initial response:', msg);
        showDetails(msg);
      })
      .catch(err => {
        console.error('Webhook error:', err);
        hideSpinner();
      })
  }
}

// Real-time updates via Supabase
let activeChannel = null; // Track active subscription

function subscribeToStatusUpdates(requestId, action) {
  // Unsubscribe from any previous channel
  if (activeChannel) {
    activeChannel.unsubscribe();
  }
  
  console.log('Subscribing to updates for Request ID:', requestId);
  
  // Create new channel
  activeChannel = supabase
    .channel(`status-updates-${requestId}`)
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'vm_creation_requests',
        filter: `form_submission_unique_id=eq.${requestId}`
      },
      (payload) => {
        console.log('‚ú® Real-time update received:', payload.new);
        handleRealtimeUpdate(payload.new, action);
      }
    )
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        console.log('‚úÖ Subscribed to real-time updates');
        // showMessage('üì° Monitoring status in real-time...', 'info');
        showProgress('üì° Monitoring status in real-time...', 'info');
      }
    });
    
  // Auto-unsubscribe after 30 minutes (optional cleanup)
  setTimeout(() => {
    if (activeChannel) {
      activeChannel.unsubscribe();
      hideSpinner();
      console.log('Unsubscribed after timeout');
    }
  }, 1800000); // 30 minutes
}

function handleRealtimeUpdate(data, action) {
  // Format the update as a nice message
  const statusMessage = formatStatusUpdate(data);
  
  // Update feedback panel with new status
  // showFeedbackPanel(JSON.stringify(data), 'success', `Status: ${data.request_status}`);
  // showFeedback(JSON.stringify(data), 'success', `Status: ${data.request_status}`);
  showProgress(formatResponseData(data, 'status_update'), 'success', `Status: ${data.request_status}`);
  
  // // Show toast notification
  // showMessage(statusMessage, 'success');
  
  // Check if workflow is complete
  if (action === 'run_simulation_simple' && data.request_status === 'simulation_running') {
    showMessage('‚úÖ Workflow completed!', 'success');
    // showProgress('‚úÖ Workflow completed!', 'success');
    hideSpinner();
    // Unsubscribe since workflow is done
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    } 
  } else if (action === 'stop_simulation' && data.request_status === 'finalized') {
    showMessage('‚úÖ Workflow completed!', 'success');
    // showProgress('‚úÖ Workflow completed!', 'success');
    hideSpinner();
    // Unsubscribe since workflow is done
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    }  
  } else if (data.request_status === 'failed') {
    showMessage('‚ùå Failed to copy', 'failed');
    // showProgress('‚úÖ Workflow completed!', 'success');
    hideSpinner();
    // Unsubscribe since workflow is done
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    }
  }

}

function formatStatusUpdate(data) {
  const statusMessages = {
    'processing': '‚è≥ Processing your request...',
    'provisioning_vm': 'üîÑ Creating your VM...',
    'vm_ready': '‚úÖ VM is ready!',
    'uploading_data': 'üì§ Uploading your data...',
    'simulation_running': 'üöÄ Simulation is running!',
    'simulation_paused': '‚è∏Ô∏è Simulation paused',
    'simulation_complete': '‚úÖ Simulation complete!',
    'finalized': 'üí∞ Processing finalized'
  };
  
  return statusMessages[data.request_status] || `Status: ${data.request_status}`;
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
