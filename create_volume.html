<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create a new Volume</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <script src="js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="auth.js"></script>
  <script src="utils.js"></script>
</head>

<body>

<div class="main-wrapper">
  <!-- Workflow Sidebar -->
  <leftside>
    <div class="workflow-sidebar mb-3">
      <h6 class="mb-3"><strong>Volume Creation Guide</strong></h6>
      
      <div class="workflow-step active" onclick="showHelp('create')">
        <div class="icon">1</div>
        <div>Create Volume</div>
      </div>

      <div class="workflow-step" onclick="showHelp('size')">
        <div class="icon">2</div>
        <div>Choose Size</div>
      </div>

      <div class="workflow-step" onclick="showHelp('attach')">
        <div class="icon">3</div>
        <div>Attach to VM</div>
      </div>

      <div class="workflow-step" onclick="showHelp('mount')">
        <div class="icon">4</div>
        <div>Mount & Format</div>
      </div>

      <div class="workflow-step" onclick="showHelp('usage')">
        <div class="icon">üí°</div>
        <div>Usage Tips</div>
      </div>

      <div class="workflow-step" onclick="showHelp('cost')">
        <div class="icon">üí∞</div>
        <div>Cost Info</div>
      </div>
    </div>
  </leftside>

  <!-- Main Content -->
  <main class="main-content">
    <nav class="breadcrumbs" aria-label="breadcrumb">
      <ol>
        <li><a href="project_panel.html">üè† Home</a></li>
        <li class="active">Create Volume</li>
      </ol>
    </nav>
    <!-- Main Form Card -->
    <!-- <div class="card"> -->
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="mb-0">üíæCreate Volume</h2>
            <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
              <span style="background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 1rem; display: inline-flex; align-items: center; gap: 6px;">
                <span style="font-size: 1.2rem;">üìÇ</span>
                <span id="projectNameDisplay">Loading...</span>
              </span>
              <small style="opacity: 0.75;">
                <code class="text-white" id="projectIdDisplay" style="font-size: 0.85rem;">Loading...</code>
              </small>
            </div>
          </div>
          <div class="d-flex gap-1">
            <!-- Documentation Links -->
            <div class="btn-group" role="group">
              <a href="documentation.html" class="btn btn-outline-light btn-sm" target="_blank" title="Complete User Guide">
                üìñ Docs
              </a>
              <a href="cheatsheet.html" class="btn btn-outline-light btn-sm" target="_blank" title="Quick Reference">
                ‚ö° Cheat Sheet
              </a>
            </div>
            <button class="btn btn-light btn-sm" onclick="goBackToProjectPanel()">‚Üê Back</button>
          </div>
        </div>
      </div>

      <div class="card-body" style="background:white; padding: 5px;">
        <div class="row">
          <div class="col-md-6">
              <label class="form-label"><strong>Small/Medium Volume</strong></label>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="50GB" value="50">
                  <label class="form-check-label" for="50GB">50GB <small><span class="text-muted">$0.00485/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="100GB" value="100">
                  <label class="form-check-label" for="100GB">100GB <small><span class="text-muted">$0.0097/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="200GB" value="200">
                  <label class="form-check-label" for="200GB">200GB <small><span class="text-muted">$0.0194/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="400GB" value="400">
                  <label class="form-check-label" for="400GB">400GB <small><span class="text-muted">$0.0388/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="500GB" value="500">
                  <label class="form-check-label" for="500GB">500GB <small><span class="text-muted">$0.0485/hour</span></small></label>
              </div>
          </div>
          <div class="col-md-6">
              <label class="form-label"><strong>Large Volume</strong></label>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="1TB" value="1000">
                  <label class="form-check-label" for="1TB">1TB <small><span class="text-muted">$0.097/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="2TB" value="2000">
                  <label class="form-check-label" for="2TB">2TB <small><span class="text-muted">$0.194/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="4TB" value="4000">
                  <label class="form-check-label" for="4TB">4TB <small><span class="text-muted">$0.388/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="5TB" value="5000">
                  <label class="form-check-label" for="5TB">5TB <small><span class="text-muted">$0.485/hour</span></small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="volume_size" id="10TB" value="10000">
                  <label class="form-check-label" for="10TB">10TB <small><span class="text-muted">$0.97/hour</span></small></label>
              </div>
          </div>
        </div>
        <div class="mb-3">
            <!-- <label for="projectId" class="form-label"><strong>VM Name</strong></label> -->
            <input type="text" 
                    id="volumeName" 
                    class="form-control" 
                    placeholder="Volume Name"
                    onkeypress="handleEnter(event)">
        </div>
        <button id="createVolumeButton" class="btn btn-primary" data-loading="Creating Volume...">‚ñ∂Ô∏è Create Volume</button>
      </div>

      <!-- Help Card (contextual) -->
      <div class="help-card mt-3" id="helpCard" >
        <div id="helpContent">
          <strong>üìã Step 1: Create Your VM</strong>
          <p class="mb-2 mt-2">Select your GPU flavor and base image, then create your VM. This typically takes 2-3 minutes.</p>
        </div>
      </div>

  </main>

  <!-- <rightside> -->
  <rightside class="rightside">

    <div id="progress-panel" class="card mt-1" style="box-shadow: none; border: 1px solid #757de7;">
      <div class="card-header" style="background: #757de7; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">üß© Progress</h6>
        </div>
      </div>
      <div class="card-body" style="max-height: 160px; overflow-y: auto; padding: 0;">
          <div id="progress-content" class="alert alert-info" role="alert">
            Ready, waiting for user action.
          </div>
      </div>
    </div>

    <div class="card mt-4" style="box-shadow: none; border: 1px solid #7e3baa;">
      <div class="card-header" style="background: #7e3baa; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üîç Details</h6>
          </div>
        </div>
      </div>
      <div class="card-body p-3" id="markdown-volume">
          <!-- Rendered markdown HTML goes here -->
      </div>
    </div>

    <!-- </div> -->
    <div id="status-message"></div>
  
    <div id="errorCard" class="card mt-4" style="display:none; box-shadow: none; border: 1px solid #e74a4a;">
      <div class="card-header" style="background: #e74a4a; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üö´ Errors</h6>
          </div>
        </div>
      </div>
      <div id="errorPanel" style="max-height: 100px; overflow-y: auto; padding: 0;">
        <div class="text-center text-muted p-3">
        </div>
      </div>
    </div>
  </rightside>
</div>

<script>

let projectId = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('Create VM page loaded');

  // check if user is allowed
  currentUser = await requireAuth();
  if (!currentUser) {
    showMessage('You are not logged-in as an authenticated user', 'danger');
    return;
  }
  

  projectId = getProjectIdFromUrl();
  const projectName = await getProjectNameFromSupabase(projectId);
  console.log('Project Name:', projectName);
  // Validate project ID
  if (!projectId) {
    showMessage('No project ID provided', 'danger');
  } else {
    console.log('Project ID loaded:', projectId);
  }

  // Check credits
  const hasCredits = await checkCredits(projectId);
  
  if (!hasCredits) {
    console.log('üí∞‚ùå Project is out of credits - interface disabled');
  } else {
    console.log('‚úÖ Project has credits - interface enabled');
  }

 // Display project info
  document.getElementById('projectIdDisplay').textContent = projectId;
  document.getElementById('projectNameDisplay').textContent = projectName;
  console.log('Project ID:', projectId);
});

// Help content for each workflow step
  const helpContent = {
    create: {
      title: 'üìãStep 1: Create Your Volume',
      content: `<p>Select size and give it a name. Volume creation takes 2-5 minutes.</p>
      <p><strong>What are Volumes?</strong></p>
      <ul class="mb-0">
        <li>Persistent network-based SSDs</li>
        <li>Retain data across VM lifecycles</li>
        <li>Can be attached/detached from VMs</li>
        <li>Up to 10 volumes per VM</li>
        <li>Ideal for datasets, scripts, and outputs</li>
      </ul>`
    },
    size: {
      title: 'üíæStep 2: Choose Volume Size',
      content: `<p><strong>Available Sizes:</strong></p>
      <table class="table table-sm table-bordered">
        <tr><td><strong>50GB - 500GB</strong></td><td>Small to medium datasets</td></tr>
        <tr><td><strong>1TB - 10TB</strong></td><td>Large datasets, multiple projects</td></tr>
      </table>
      <p><strong>üí°Sizing Tips:</strong></p>
      <ul class="mb-0">
        <li>Estimate: Dataset + Output + 20% margin</li>
        <li>Start smaller, create additional volumes if needed (number of volumes does not influence the per GB cost)</li>
        <li>Consider compression for large datasets</li>
        <li>Account for checkpoints (can be large!)</li>
      </ul>`
    },
    attach: {
      title: 'üîóStep 3: Attach to VM',
      content: `<p><strong>After volume is created:</strong></p>
      <ol>
        <li>Go to <strong>Manage VMs</strong></li>
        <li>Select the VM you want to attach the volume to</li>
        <li>In the <strong>Details</strong> section, click <strong>Attach Volume</strong></li>
        <li>Choose the target Volume from list</li>
        <li>Click on <strong>Attach Volume</strong></li>
        <li>Note the device path shown in UI</li>
      </ol>
      <p><strong>‚ö†Ô∏èImportant:</strong></p>
      <ul class="mb-0">
        <li>Volumes can only be attached to <strong>one VM at a time</strong></li>
        <li>Copy the device path for mounting</li>
      </ul>`
    },
    mount: {
      title: 'üíøStep 4: Mount & Format',
      content: `<p><strong>After attaching in UI:</strong></p>
      <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
        <code># 1. Copy device path from UI<br>
        DEVICE="/dev/disk/by-id/virtio-xxxxx"<br><br>
        # 2. Format (FIRST TIME ONLY!)<br>
        sudo mkfs.ext4 -F \${DEVICE}<br><br>
        # 3. Create mount point<br>
        sudo mkdir -p /mnt/user_volume<br><br>
        # 4. Mount<br>
        sudo mount \${DEVICE} /mnt/user_volume<br><br>
        # 5. Verify<br>
        df -h | grep user_volume</code>
      </div>
      <p><strong>‚ö†Ô∏èWarning:</strong> Only format on <strong>first use</strong>! Formatting erases all data.</p>
      <p><strong>Before Detaching:</strong></p>
      <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
        <code>sync<br>
        sudo umount /mnt/user_volume</code>
      </div>`
    },
    usage: {
      title: 'üí°Volume Usage Tips',
      content: `<p><strong>Best Practices:</strong></p>
      <ul>
        <li><strong>Use staging VM</strong> for data uploads (cheap CPU VM)</li>
        <li><strong>Auto-mount</strong> via /etc/fstab for convenience</li>
        <li><strong>Always unmount</strong> before detaching in UI</li>
        <li><strong>Share volumes</strong> across team (attach/detach as needed)</li>
        <li><strong>Regular snapshots</strong> for important data</li>
      </ul>
      <p><strong>Auto-mount on Boot:</strong></p>
      <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0; font-size:0.85rem;">
        <code># Get UUID<br>
        sudo blkid \${DEVICE}<br><br>
        # Add to /etc/fstab<br>
        sudo vm /etc/fstab<br>
        # Add line:<br>
        UUID=your-uuid /mnt/user_volume ext4 defaults,nofail 0 2<br><br>
        # Test<br>
        sudo mount -a</code>
      </div>
      <p class="mb-0"><strong>üí°Tip:</strong> Use <code>nofail</code> option if volume isn't always attached!</p>`
    },
    cost: {
      title: 'üí∞Cost Information',
      content: `<p><strong>Volume Pricing:</strong></p>
      <ul>
        <li>$0.097 per TB per hour</li>
      </ul>
      <p><strong>Example Costs:</strong></p>
      <table class="table table-sm table-bordered">
        <tr><td>100GB for 1 week</td><td>~$1.63</td></tr>
        <tr><td>500GB for 1 month</td><td>~$7</td></tr>
        <tr><td>1TB for 1 week</td><td>~$16.3</td></tr>
        <tr><td>1TB for 1 month</td><td>~$70</td></tr>
      </table>
      <p><strong>üí°Save Money:</strong></p>
      <ul class="mb-0">
        <li>Delete volumes when done with project</li>
        <li>Compress data before storing</li>
        <li>Share volumes across team members</li>
        <li>Right-size - don't over-provision</li>
        <li>Download results then delete volume</li>
      </ul>`
    }
  };

function showHelp(step) {
  const help = helpContent[step];
  document.getElementById('helpContent').innerHTML = `
    <strong>${help.title}</strong>
    <p class="mb-0 mt-2">${help.content}</p>
  `;
  
  // Update active state
  document.querySelectorAll('.workflow-step').forEach(el => {
    el.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
}

function goBackToProjectPanel() {
  window.location.href = `project_panel.html?project_id=${encodeURIComponent(projectId)}`;
}

function getFormInputs() {
  // Get selected volume size
  const volumeSizeRadios = document.querySelectorAll('input[name="volume_size"]:checked');
  const volume_size = volumeSizeRadios.length > 0 ? volumeSizeRadios[0].value : null;
  
  // Get Volume name
  const volume_name = sanitizeInput(document.getElementById('volumeName').value.trim());
  
  console.log('volumeSize:', volume_size, 'volumeName:', volume_name, 'projectId:', projectId);
  
  return { volume_size, volume_name, projectId };
}

function validateFormInputs(inputs) {
  const errors = [];
  if (!inputs.volume_size) { errors.push('Please select a volume size'); }
  if (!inputs.volume_name) { errors.push('Please enter a volume name'); }
  if (!inputs.projectId) { errors.push('Project ID is missing'); }
  return errors;
}

document.getElementById("createVolumeButton").addEventListener("click", async () => {
  const createVolumeButton = document.getElementById("createVolumeButton");

  // Disable button immediately
  createVolumeButton.disabled = true;
  const originalText = createVolumeButton.textContent;
  // createVmButton.textContent = "‚è≥ Creating VM...";

  // visual polish (change color while disabled)
  createVolumeButton.classList.remove("btn-primary");
  createVolumeButton.classList.add("btn-secondary");

  // Show spinner + text
  createVolumeButton.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    ‚è≥ Creating Volume...
  `;

  try {
    await createVolume();
  } catch (err) {
    console.error('Unhandled error in createVm:', err);
    showMessage(`Unexpected error: ${err.message}`, 'danger');
  } finally {
    // Re-enable button after all async work is done
    createVolumeButton.disabled = false;
    createVolumeButton.textContent = originalText;

    // Restore original color
    createVolumeButton.classList.remove("btn-secondary");
    createVolumeButton.classList.add("btn-primary");
  }
});

function resetErrorCard() {
  const errorPanel = document.getElementById('errorPanel');
  const errorCard = document.getElementById('errorCard');
  if (errorPanel && errorCard) {
    errorPanel.innerHTML = '';          // Clear previous error content
    errorCard.style.display = 'none';   // Hide the card
  }
}

async function createVolume() {
  // üßπ Reset any previous error display
  resetErrorCard();
  clearProgressPanel();

  // Check credits
  const hasCredits = checkCredits(projectId);
  console.log('checkCredits called with project id', projectId);
  if (!hasCredits) {
    console.log('üí∞‚ùå Project is out of credits - interface disabled');
  } else {
    console.log('‚úÖ Project has credits - interface enabled');
  }

  // Get and validate inputs
  const inputs = getFormInputs();
  const errors = validateFormInputs(inputs);
  
  if (errors.length > 0) {
    showMessage(errors.join(' | '), 'warning');
    return;
  }
  
  console.log('Creating VM with inputs:', inputs);
  return await triggerVolumeCreation('create_volume', inputs);
}

async function triggerVolumeCreation(action, inputs) {
  
  // let requestId = null;
  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/${action}`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', inputs);
    showProgress("Volume Creation is starting", 'info', 'create_volume');
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(inputs)
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.message || 'Action failed');
    }
    
    showProgress("Volume creation is starting", 'info', 'volume_creation');
    //CheckVolumeStatus(volumeName.user_vm_name);
    console.log('Response received:', data);
    
    if (data.success) {
      showProgress('Volume creation is over', 'info', 'vm_available');
      displayVolumeDetails(data);
      // loadVolumes();
      return;
    } else {
        showProgress(`Volume creation failed: ${data.message || 'Unknown error'}`, 'danger', 'volume_error');
        showError(JSON.stringify(data));
        throw new Error(data.message || 'Action failed');
    }
    
  } catch (error) {
    console.error('Error:', error);
    showProgress(`Error: ${error.message}`, 'danger', 'volume_error');
    showError(error.message);
    throw error; // Re-throw so caller knows it failed
  }
}

async function loadVolumes() {
  const refreshBtn = document.getElementById('refreshVmsButton');
  const refreshText = document.getElementById('refreshBtn-text');

  // Disable button immediately and show spinner
  refreshBtn.disabled = true;
  const originalHTML = refreshBtn.innerHTML;

  refreshBtn.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    Refreshing GPU VMs...
  `;

  const payload = { project_id: projectId };

  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/list_vms`;
    
    console.log('Calling webhook:', webhookUrl, 'with payload:', payload);
    // showProgress("VMs listing", 'info', 'list_vms');
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    console.log('Response received:', data);
    
    if (data.success) {
      // showMessage(`üîÑ VM list updated`, 'success');
      // showProgress('.', 'info', 'list_vms');
      //list the VMs
      displayVmsList(data);
    } else {
      // showProgress(`‚ùåVM listing failed: ${data.message || 'Unknown error'}`, 'danger', 'list_vms');
      document.getElementById('vmsList').innerHTML = '<div class="text-secondary p-3">No VMs to display, go to "Create VM" page: <button class="btn btn-primary btn-sm" onclick="goToCreateVmPage()">‚ñ∂Ô∏è Create VM</button></div>';
    }
    
  } catch (error) {
    console.error('Error:', error);
    showProgress(`Error: ${error.message}`, 'danger', 'list_vms');
    showError(error.message);
  } finally {
    // 2Ô∏è‚É£ Re-enable button and restore original content
    refreshBtn.disabled = false;
    refreshBtn.innerHTML = originalHTML;
  }
}

function handleEnter(event) {
  if (event.key === 'Enter') {
    createVolume();
  }
}


</script>

</body>