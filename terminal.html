<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU VM Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css">
    <style>
        body {
            margin: 0;
            background-color: #1e1e1e;
            color: #f0f0f0;
        }
        #terminal-container {
            width: 100vw;
            height: calc(100vh - 60px);
            outline: none; /* Remove focus outline */
        }
        .header-bar {
            background: #343a40;
            color: #fff;
            padding: 10px 15px;
            display: flex;
           -content: space-between;
            align-items: center;
        }
        .header-bar h5 {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <h5 id="vm-info">Connecting...</h5>
        <button class="btn btn-danger btn-sm" onclick="window.close()">Close Tab</button>
    </div>
    <div id="terminal-container" tabindex="0"></div>

    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const vmIp = urlParams.get('host');
        const projectId = urlParams.get('project_id');
        const projectName = urlParams.get('project_name');

        if (!vmIp || !projectId || !projectName) {
            document.body.innerHTML = '<h2 class="text-danger text-center mt-5">Missing parameters!</h2>';
            throw new Error('Required parameters missing');
        }

        document.getElementById('vm-info').textContent = `VM: ${vmIp} | Project: ${decodeURIComponent(projectName)}`;

        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            theme: { background: '#1e1e1e', foreground: '#f0f0f0', cursor: '#ffffff' }
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        term.writeln(`\x1b[33mâ³ Connecting to ${vmIp}...\x1b[0m\r`);

        const wsUrl = `wss://adolfo-unpersonalizing-unnarrowly.ngrok-free.dev?host=${vmIp}&port=22&project_id=${projectId}&project_name=${encodeURIComponent(projectName)}`;
        const socket = new WebSocket(wsUrl);

        socket.onopen = () => term.writeln(`\x1b[32mâœ… Connected to ${vmIp}\x1b[0m\r`);
        socket.onmessage = (event) => term.write(event.data);
        socket.onerror = () => term.writeln(`\r\n\x1b[31mâŒ Connection error\x1b[0m\r\n`);
        socket.onclose = () => term.writeln(`\r\n\r\n\x1b[33mðŸ”Œ Connection closed\x1b[0m`);

        term.onData(data => {
            if (socket.readyState === WebSocket.OPEN) socket.send(data);
        });

        // âœ… Make container focusable for Ctrl+V
        const terminalContainer = document.getElementById('terminal-container');
        terminalContainer.focus();

        // âœ… Handle paste (Ctrl+V and right-click)
        terminalContainer.addEventListener('paste', (event) => {
            event.preventDefault();
            const text = event.clipboardData.getData('text');
            if (text && socket.readyState === WebSocket.OPEN) {
                socket.send(text);
            }
        });

        // âœ… Handle Shift+Insert for paste
        term.attachCustomKeyEventHandler((e) => {
            if (e.shiftKey && e.key === 'Insert') {
                navigator.clipboard.readText().then(text => {
                    if (socket.readyState === WebSocket.OPEN) socket.send(text);
                });
                return false;
            }
            if (e.ctrlKey && e.key === 'c') {
                const selection = term.getSelection();
                if (selection) navigator.clipboard.writeText(selection);
                e.preventDefault();
                return false;
            }
            return true;
        });
    </script>
</body>
</html>
