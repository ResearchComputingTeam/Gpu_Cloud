<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create a new VM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="js/config.js"></script>
  <!-- <script src="auth.js"></script> -->
  <script src="utils.js"></script>
</head>

<body>

<div class="main-wrapper">
  <!-- Workflow Sidebar -->
  <leftside>
    <div class="workflow-sidebar mb-3">
      <h6 class="mb-3"><strong>VM Creation Workflow</strong></h6>
      
      <div class="workflow-step active" onclick="showHelp('create')">
        <div class="icon">1</div>
        <div>Create VM</div>
      </div>

      <div class="workflow-step" onclick="showHelp('choose')">
        <div class="icon">2</div>
        <div>HW Flavor & Image</div>
      </div>

      <div class="workflow-step" onclick="showHelp('ssh')">
        <div class="icon">3</div>
        <div>SSH Access</div>
      </div>

      <div class="workflow-step" onclick="showHelp('software')">
        <div class="icon">4</div>
        <div>Setup Software</div>
      </div>
        
      <div class="workflow-step" onclick="showHelp('upload')">
        <div class="icon">5</div>
        <div>Upload Data</div>
      </div>
      
      <div class="workflow-step" onclick="showHelp('run')">
        <div class="icon">6</div>
        <div>Run Tasks</div>
      </div>
      
      <div class="workflow-step" onclick="showHelp('download')">
        <div class="icon">7</div>
        <div>Download Results</div>
      </div>

      <div class="workflow-step" onclick="showHelp('storage')">
        <div class="icon">A</div>
        <div>Storage Types</div>
      </div>
<!-- 
      <div class="mt-3 p-2" style="background: #e8f4f8; border-radius: 6px; font-size: 0.8rem; border-left: 3px solid #667eea;">
        <strong>üí° Quick Help</strong><br>
        <small class="text-muted">Click any action above for copy-ready commands</small>
      </div> -->

    </div>
  </leftside>

  <!-- Main Content -->
  <main class="main-content">
    <nav class="breadcrumbs" aria-label="breadcrumb">
      <ol>
        <li><a href="project_panel.html">üè† Home</a></li>
        <li class="active">Create VM</li>
      </ol>
    </nav>
  
    <!-- Main Form Card -->
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="mb-0">üíªCreate VM</h2>
            <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
              <span style="background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 1rem; display: inline-flex; align-items: center; gap: 6px;">
                <span style="font-size: 1.2rem;">üìÇ</span>
                <span id="projectNameDisplay">Loading...</span>
              </span>
              <small style="opacity: 0.75;">
                <code class="text-white" id="projectIdDisplay" style="font-size: 0.85rem;">Loading...</code>
              </small>
            </div>
          </div>
          <div class="d-flex gap-1">
            <div class="btn-group" role="group">
              <a href="documentation.html" class="btn btn-outline-light btn-sm" target="_blank" title="Complete User Guide">
                üìñ Docs
              </a>
              <a href="cheatsheet.html" class="btn btn-outline-light btn-sm" target="_blank" title="Quick Reference">
                ‚ö°Cheat Sheet
              </a>
            </div>
            <button class="btn btn-light btn-sm" onclick="goBackToProjectPanel()">‚Üê Back</button>
          </div>
        </div>
      </div>

      <div class="card-body" style="background:white; padding: 5px;">
        <div class="row">
          <div class="col-md-6">
              <label class="form-label"><strong>Hardware Flavor</strong></label>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="flavor" id="n1-cpu-small" value="n1-cpu-small">
                  <label class="form-check-label" for="n1-cpu-small">CPU Only <small class="text-muted">$0.3484/hour (can be used as staging VM)</small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="flavor" id="n3-A100x1" value="n3-A100x1">
                  <label class="form-check-label" for="n3-A100x1">Single A100 GPU PCIe <small class="text-muted">$1.35/hour</small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="flavor" id="n3-H100x1" value="n3-H100x1">
                  <label class="form-check-label" for="n3-H100x1">Single H100 GPU PCIe <small class="text-muted">$1.90/hour</small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="flavor" id="n3-H100x4" value="n3-H100x4">
                  <label class="form-check-label" for="n3-H100x4">4 x H100 GPU PCIe <small class="text-muted">$7.60/hour</small></label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="flavor" id="n3-H100x8" value="n3-H100x8">
                  <label class="form-check-label" for="n3-H100x8">8 x H100 GPU PCIe <small class="text-muted">$15.20/hour</small></label>
              </div>
          </div>
          <div class="col-md-6">
              <label class="form-label"><strong>Base Image</strong></label>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="image" id="vanilla" value="Ubuntu Server 22.04 LTS (Jammy Jellyfish)">
                  <label class="form-check-label" for="vanilla">Ubuntu Server 22.04</label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="image" id="cuda" value="Ubuntu Server 22.04 LTS R535 CUDA 12.21">
                  <label class="form-check-label" for="cuda">Ubuntu Server 22.04 + CUDA 12.2</label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="image" id="minimal" value="minimal-research-base-image">
                  <label class="form-check-label" for="minimal">minimal-research-base-image</label>
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="radio" name="image" id="ml_dl" value="ml-dl-gpu-base-image">
                  <label class="form-check-label" for="ml_dl">ml-dl-gpu-base-image</label>
              </div>
          </div>
        </div>
        <div class="mb-3 mt-3">
            <!-- <label for="projectId" class="form-label"><strong>VM Name</strong></label> -->
            <input type="text" 
                    id="vmName" 
                    class="form-control" 
                    placeholder="VM Name"
                    onkeypress="handleEnter(event)">
        </div>
        <button id="createVmButton" class="btn btn-primary" data-loading="‚è≥Creating VM...">‚ñ∂Ô∏è Create VM</button>
      </div>

      <!-- Help Card (contextual) -->
      <div class="help-card mt-3" id="helpCard" >
        <div id="helpContent">
          <strong>üìã Step 1: Create Your VM</strong>
          <p class="mb-2 mt-2">Select your GPU flavor and base image, then create your VM. This typically takes 2-3 minutes.</p>
        </div>
      </div>

      <!-- Terminal container -->
      <div class="card mt-3" id="terminal-card" style="display: none;">
        <div class="card-header" style="background: #1e1e1e; color: white;">
          <div class="d-flex justify-content-between align-items-center">
            <strong>üñ•Ô∏è SSH Terminal - <span id="terminal-vm-name"></span></strong>
            <button class="btn btn-sm btn-outline-light" onclick="disconnectTerminal()">
              Disconnect
            </button>
          </div>
        </div>
        <div class="card-body p-0" style="background: #1e1e1e;">
          <div id="terminal" style="padding: 10px;"></div>
        </div>
      </div>
  </main>

  <!-- <rightside> -->
  <rightside class="rightside">

    <div id="progress-panel" class="card mt-1" style="box-shadow: none; border: 1px solid #757de7;">
      <div class="card-header" style="background: #757de7; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">üß© Progress</h6>
        </div>
      </div>
      <div class="card-body" style="max-height: 160px; overflow-y: auto; padding: 0;">
          <div id="progress-content" class="alert alert-info" role="alert">
            Ready, waiting for user action.
          </div>
      </div>
    </div>

    <div class="card mt-4" style="box-shadow: none; border: 1px solid #7e3baa;">
      <div class="card-header" style="background: #7e3baa; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üîç Details</h6>
          </div>
        </div>
      </div>
      <div class="card-body p-3" id="markdown-content-create">
          <!-- Rendered markdown HTML goes here -->
      </div>
    </div>

    <!-- </div> -->
    <div id="status-message"></div>
  
    <div id="errorCard" class="card mt-4" style="display:none; box-shadow: none; border: 1px solid #e74a4a;">
      <div class="card-header" style="background: #e74a4a; padding: 6px 6px; line-height: 1.1;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0">üö´ Errors</h6>
          </div>
        </div>
      </div>
      <div id="errorPanel" style="max-height: 100px; overflow-y: auto; padding: 0;">
        <div class="text-center text-muted p-3">
        </div>
      </div>
    </div>
  </rightside>
</div>

<script>
let currentUser = null;


let projectId = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('Create VM page loaded');
  // check if user is allowed
  currentUser = await requireAuth();
  if (!currentUser) {
    showMessage('You are not logged-in as an authenticated user', 'danger');
    return;
  }
  

  projectId = getProjectIdFromUrl();
  const projectName = await getProjectNameFromSupabase(projectId);
  console.log('Project Name:', projectName);
  // const projectName = localStorage.getItem('currentProjectName') || 'Untitled Project';

  // Validate project ID
  if (!projectId) {
    showMessage('No project ID provided', 'danger');
  } else {
    console.log('Project ID loaded:', projectId);
  }

  // Check credits
  const hasCredits = await checkCredits(projectId);
  
  if (!hasCredits) {
    console.log('üí∞‚ùå Project is out of credits - interface disabled');
  } else {
    console.log('‚úÖ Project has credits - interface enabled');
  }

 // Display project info
  document.getElementById('projectIdDisplay').textContent = projectId;
  document.getElementById('projectNameDisplay').textContent = projectName;
  console.log('Project ID:', projectId);
});

// Help content for each workflow step
const helpContent = {
  create: {
    title: 'üìã Step 1: Create Your VM',
    content: `<p>Select your GPU flavor and base image, then create your VM. This typically takes 2 to 5 minutes.'
        <p><strong>Quick Tips:</strong></p>
    <ul class="mb-0">
      <li>Use <strong>CPU-only VM</strong> ($0.35/hr) as staging for data uploads</li>
      <li>Choose GPU based on your model size (A100 for large models, H100 for fastest training)</li>
      <li>Select base image: <code>ml-dl-gpu-base-image</code> for ML/DL work</li>
    </ul>`
  },
  choose: {
    title: 'üéÆ Step 2: Choose Flavor & Image',
    content: `<p><strong>Hardware Flavors:</strong></p>
    <ul>
      <li><strong>n1-cpu-small</strong>: $0.35/hr - Perfect for staging and data uploads</li>
      <li><strong>n3-A100x1</strong>: $1.35/hr - Single A100 GPU for most ML tasks</li>
      <li><strong>n3-H100x1</strong>: $1.90/hr - High-performance for large models</li>
      <li><strong>n3-H100x4/x8</strong>: Multi-GPU for distributed training</li>
    </ul>
    <p><strong>Base Images:</strong></p>
    <ul class="mb-0">
      <li><strong>Ubuntu 22.04</strong>: Clean system for custom setups</li>
      <li><strong>Ubuntu + CUDA 12.2</strong>: GPU-ready with CUDA toolkit</li>
      <li><strong>minimal-research-base-image</strong>: Scientific Python, HDF5, NetCDF, JupyterLab...</li>
      <li><strong>ml-dl-gpu-base-image</strong>: PyTorch 2.5.1, TensorFlow 2.14, full ML stack...</li>
    </ul>`
  },
  ssh: {
    title: 'üîë Step 3: SSH Access',
    content: `<p>Once your VM is ready, connect via SSH:</p>
    <p class="mb-0 mt-0"><strong>To access your VM, you first need to:</strong></p>
    <ol class="mb-0 mt-0">
      <li>Generate your own SSH key pair (can be ignored if you already have a ssh key)</li>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
          <code>ssh-keygen -t ed25519 -f ~/.ssh/my_ssh_key</code>
          <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('ssh-keygen -t ed25519 -f ~/.ssh/my_ssh_key')">Copy</button>
        </div>
        <p class="mt-2 mb-0">Then you need to restrict the priviledges of your private key as follows:</p>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
          <code>chmod 600 ~/.ssh/my_ssh_key</code>
          <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('chmod 600 ~/.ssh/my_ssh_key')">Copy</button>
        </div>
      <li>Import the public part of this key pair (aka your public key) to your VM:</li>
        <ol class="mb-0">
          <li>Go to "Manage VMs" page, select your target VM</li>
          <li>In the "Details" panel, click on "‚ûïüîêImport my SSH public key" button</li>
          <li>Paste the content of your public key (my_ssh_key.pub) into the displayed field and click "import"</li>
          <li>‚ö†Ô∏èWarning: don't paste the content of your private key (my_ssh_key), this should never be disclosed</li>
        </ol>
      <li>Then you can access your VM through the <strong>SSH Command</strong> by pointing to the path of your private ssh keys:</li>
        <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
          <code>ssh -i ~/.ssh/my_ssh_key ubuntu@&lt;VM_IP&gt;</code>
          <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('ssh -i ~/.ssh/my_ssh_private_key ubuntu@&lt;VM_IP&gt;')">Copy</button>
        </div>
        <div>
          <p class="mt-2 mb-0"><strong>Alternative: Use MobaXterm (Windows):</strong></p>
            <ol class="mb-0">
              <li>Create new SSH session</li>
              <li>Enter VM IP address</li>
              <li>Specify username</li>
              <li>Use private key authentication (in "Advanced SSH settings")</li>
              <li>Save session for future use</li>
            </ol>
        </div>
    </ol>`
  },
  software: {
    title: '‚öôÔ∏è Step 4: Setup Software Stack',
    content: `<p><strong>Using Environment Modules (Pre-installed):</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
      <code># List available modules<br>
      module avail<br><br>
      # Load Anaconda<br>
      module load anaconda3/2024.02-1<br><br>
      # Load complete ML/DL stack<br>
      module load ml_dl_gpu_base_all</code>
    </div>
    <p><strong>Installing Additional Packages:</strong></p>
    <div class="cmd-block" style="background:#2d2d2d; color:#f8f8f2; padding:8px; border-radius:4px; margin:8px 0;">
      <code># Create conda environment<br>
      conda create -n myenv python=3.11 -y<br>
      conda activate myenv<br>
      pip install transformers datasets</code>
    </div>
    <p class="mb-0"><strong>‚úÖ Verify GPU:</strong> <code>nvidia-smi</code></p>`
  },
  upload: {
    title: 'üì§ Step 5: Upload Your Code & Data',
    content: `<p>Once your VM is running, you can upload your code, data, and dependencies. 
    <p><strong>‚ö†Ô∏èImportant:</strong> Use a <strong>staging VM</strong> (cheap CPU) + volume for data uploads to save money!</p>
        <p><strong>Upload Strategy:</strong></p>
        <ol>
          <li>Create a volume (Project ‚Üí Create Volume)</li>
          <li>Create staging VM (CPU-only flavor)</li>
          <li>Attach volume to staging VM</li>
          <li>Mount volume and upload data</li>
          <li>Unmount, detach, attach to GPU VM</li>
        </ol>
    <p>Use <code>rsync</code> to transfer files securely:</p>
    <p><strong>Upload Command (from laptop):</strong></p>
    <code style="background:#f8f9fa; padding:8px; display:block; border-radius:4px; margin:8px 0;">
      rsync -avz -P --checksum -e "ssh -i /path/to/ssh_private_key" ./dataset/ ubuntu@staging-vm-ip:/mnt/user_volume
    </code>
    <p><strong>üìå Tip:</strong></p>
    <ul>
      <li>Place your <em>scripts and input data</em> on <strong>Volumes</strong> if you want them to persist after VM hibernation/deletion.</li>
      <li>Use <strong>ephemeral storage</strong> for temporary computations and intermediate results.</li>
      <li>Use <strong>root disk</strong> for data smaller than 50GB, it's free, and auto preserved as long as your VM is not deleted.</li>
    </ul>
    <small class="text-muted">Replace VM_IP with your actual VM IP address</small>`
  },
  run: {
    title: 'üöÄ Step 6: Run Your Tasks',
    content: `<p>SSH into your VM and run your workload:<br> <strong>‚ö†Ô∏èCritical:</strong> Always use <code>tmux</code> to keep jobs running after disconnect!</p>
      <code style="background:#f8f9fa; padding:8px; display:block; border-radius:4px; margin:8px 0;">
        ssh ubuntu@VM_IP<br>
        # Start tmux session<br>
        tmux new -s training<br><br>
        # Load modules<br>
        module load anaconda3/2024.02-1<br>
        module load ml_dl_gpu_base_all<br><br>
        # Run with output to volume<br>
        cd /your/project/path<br>
        python train.py \\<br>
        &nbsp;&nbsp;--data /mnt/user_volume/datasets/ \\<br>
        &nbsp;&nbsp;--output /mnt/user_volume/results/ \\<br>
        &nbsp;&nbsp;| tee /mnt/user_volume/logs/train.log<br><br>
        # Detach: Ctrl-B, then D<br>
        # Reattach: tmux attach -t training <br>
      </code>
          <p><strong>Monitoring:</strong></p>
      <ul class="mb-0">
        <li><code>watch -n 2 nvidia-smi</code> - GPU usage</li>
        <li><code>htop</code> - CPU/RAM usage</li>
        <li><code>df -h /mnt/user_volume</code> - Disk space</li>
      </ul>`
  },
  download: {
    title: 'üì• Step 7: Download Results',
    content: `<p><strong>From your laptop, run:</strong></p>
      <code style="background:#f8f9fa; padding:8px; display:block; border-radius:4px; margin:8px 0;">
        rsync -avz -P --checksum -e "ssh -i /path/to/ssh_private_key" ubuntu@VM_IP:/mnt/user_volume/results/ ./local_results/
      </code>`
  },
  storage: {
    title: 'üíæStorage Types',
    content: `<table class="table table-sm table-bordered">
      <tr>
        <td><strong>Root Disk</strong></td>
        <td>OS + configs (persistent while VM exists)</td>
      </tr>
      <tr>
        <td><strong>Ephemeral</strong></td>
        <td>Fast scratch (750GB/GPU, <span style="color:red;">deleted on stop!</span>)</td>
      </tr>
      <tr>
        <td><strong>Volume</strong></td>
        <td>Datasets/outputs (attach/detach, survives VM deletion)</td>
      </tr>
    </table>
    <p><strong>üí°Best Practices:</strong></p>
    <ul class="mb-0">
      <li><strong>Root disk:</strong> System packages, small configs</li>
      <li><strong>Ephemeral:</strong> Temporary files, intermediate results</li>
      <li><strong>Volume:</strong> Important data, datasets, final results</li>
      <li><strong>Always save final outputs to volume!</strong></li>
    </ul>`
  }
};

function showHelp(step) {
  const help = helpContent[step];
  document.getElementById('helpContent').innerHTML = `
    <strong>${help.title}</strong>
    <p class="mb-0 mt-2">${help.content}</p>
  `;
  
  // Update active state
  document.querySelectorAll('.workflow-step').forEach(el => {
    el.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
}

function goBackToProjectPanel() {
  window.location.href = `project_panel.html?project_id=${encodeURIComponent(projectId)}`;
}

function getFormInputs() {
  // Get selected hardware flavor
  const flavorRadios = document.querySelectorAll('input[name="flavor"]:checked');
  const flavor = flavorRadios.length > 0 ? flavorRadios[0].value : null;
  
  // Get selected base image
  const imageRadios = document.querySelectorAll('input[name="image"]:checked');
  const image = imageRadios.length > 0 ? imageRadios[0].value : null;
  
  // Get VM name
  const vmName = sanitizeInput(document.getElementById('vmName').value.trim());

  console.log('flavor:', flavor, 'image:', image, 'vmName:', vmName, 'projectId:', projectId);
  return {
    flavor,
    image,
    vmName,
    projectId
  };
}

function validateFormInputs(inputs) {
  const errors = [];
  if (!inputs.flavor) { errors.push('Please select a hardware flavor');}
  if (!inputs.image) { errors.push('Please select a base image');}
  if (!inputs.vmName) { errors.push('Please enter a VM name');}
  if (!inputs.projectId) { errors.push('Project ID is missing');}
  return errors;
}

document.getElementById("createVmButton").addEventListener("click", async () => {
  const createVmButton = document.getElementById("createVmButton");

  // Disable button immediately
  createVmButton.disabled = true;
  const originalText = createVmButton.textContent;
  // createVmButton.textContent = "‚è≥ Creating VM...";

  // visual polish (change color while disabled)
  createVmButton.classList.remove("btn-primary");
  createVmButton.classList.add("btn-secondary");

  // Show spinner + text
  createVmButton.innerHTML = `
    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
    ‚è≥Creating VM...
  `;

  try {
    await createVm();
  } catch (err) {
    console.error('Unhandled error in createVm:', err);
    showMessage(`Unexpected error: ${err.message}`, 'danger');
  } finally {
    // Re-enable button after all async work is done
    createVmButton.disabled = false;
    createVmButton.textContent = originalText;

    // Restore original color
    createVmButton.classList.remove("btn-secondary");
    createVmButton.classList.add("btn-primary");
  }
});

async function createVm() {
  // Check credits
  const hasCredits = checkCredits(projectId);
  console.log('checkCredits called with project id', projectId);
  if (!hasCredits) {
    console.log('üí∞‚ùå Project is out of credits - interface disabled');
  } else {
    console.log('‚úÖ Project has credits - interface enabled');
  }

  // Get and validate inputs
  const inputs = getFormInputs();
  const errors = validateFormInputs(inputs);
  
  if (errors.length > 0) {
    showMessage(errors.join(' | '), 'warning');
    return;
  }
  
  console.log('Creating VM with inputs:', inputs);
  return await triggerVmAction('create_vm', inputs);
}

async function triggerVmAction(action, inputs) {
  
  let requestId = null;
  try {
    const webhookUrl = `${CONFIG.API_BASE_URL}/webhook/${action}`;
    
    console.log('Calling webhook:', webhookUrl, 'with inputs:', inputs);
    showProgress('Creating VM...', 'info', action);
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(inputs)
    });
  
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.message || 'Action failed');
    }
    
    showProgress('‚úÖ Request accepted. Monitoring status...', 'success', action);
    // showDetails(JSON.stringify(data));
    
    if (!data.request_id) {
      // No real-time tracking available
      return data;
    }
    
    requestId = data.request_id;

    // Start subscription BEFORE creating the promise
    await subscribeToStatusUpdates(requestId, action);

    // Add initial polling to catch current state
    const initialStatus = await pollCurrentStatus(requestId);
    if (initialStatus) {
      handleRealtimeUpdate(initialStatus, action);
    }

    // Create promise and subscription together
    const finalData = await new Promise((resolve, reject) => {
      // Store resolver with timeout
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error(`Timed out waiting for ${action} to complete.`));
      }, 1800000); // 30 minutes

      actionResolvers[requestId] = { 
        resolve: (data) => {
          cleanup();
          resolve(data);
        },
        reject: (error) => {
          cleanup();
          reject(error);
        },
        timeout
      };
      
      // Cleanup helper
      function cleanup() {
        if (actionResolvers[requestId]) {
          clearTimeout(actionResolvers[requestId].timeout);
          delete actionResolvers[requestId];
        }
        if (activeChannel) {
          activeChannel.unsubscribe();
          activeChannel = null;
        }
      }
      
    });
    return finalData;
  } catch (error) {
    // Cleanup on any error
    if (requestId && actionResolvers[requestId]) {
      clearTimeout(actionResolvers[requestId].timeout);
      delete actionResolvers[requestId];
    }
    if (activeChannel) {
      activeChannel.unsubscribe();
      activeChannel = null;
    }
    
    showProgress(`‚ùå Error: ${error.message}`, 'danger');
    showError(error.message);
    throw error; // Re-throw so caller knows it failed
  }
}

function handleEnter(event) {
  if (event.key === 'Enter') {
    createVm();
  }
}

// Check if user is authenticated
async function requireAuth() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  
  if (!session) {
    window.location.href = 'login.html';
    return null;
  }
  
  return session.user;
}


</script>

</body>